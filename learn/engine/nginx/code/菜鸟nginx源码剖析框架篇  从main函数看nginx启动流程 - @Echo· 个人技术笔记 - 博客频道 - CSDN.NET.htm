
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
     
    <html xmlns="http://www.w3.org/1999/xhtml">
    
<head>  

    <script type="text/javascript" src="http://c.csdnimg.cn/pubfooter/js/tracking.js" charset="utf-8"></script>  

    <script type="text/javascript">
        var protocol = window.location.protocol;
        document.write('<script type="text/javascript" src="' + protocol + '//csdnimg.cn/pubfooter/js/repoAddr2.js?v=' + Math.random() + '"></' + 'script>');
    </script>

  
 <meta http-equiv="Cache-Control" content="no-siteapp" /><link rel="alternate" media="handheld" href="#" />

    <title>菜鸟nginx源码剖析 框架篇（一） 从main函数看nginx启动流程 - @Echo&#183; 个人技术笔记
        - 博客频道 - CSDN.NET</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="description" content="使用curl和模拟https操作azkaban的简单示例" />
    <script src="http://static.blog.csdn.net/scripts/jquery.js" type="text/javascript"></script>
      <script type="text/javascript" src="http://static.blog.csdn.net/scripts/jquery-version.js"></script>
    <script type="text/javascript" src="http://static.blog.csdn.net/scripts/ad.js?v=1.1"></script>
        <!--new top-->
               <link rel="stylesheet" href="http://c.csdnimg.cn/public/common/toolbar/css/index.css">        <!--new top-->
    
      <!-- ad begin -->
         <script language="javascript" type="text/javascript" src="http://ads.csdn.net/js/tracking.js"></script>
    <!-- ad end-->

    <link rel="Stylesheet" type="text/css" href="http://static.blog.csdn.net/skin/skin-blue/css/style.css?v=1.1" />
    <link id="RSSLink" title="RSS" type="application/rss+xml" rel="alternate" href="/chen19870707/rss/list" />
    <link rel="shortcut icon" href="http://c.csdnimg.cn/public/favicon.ico" />
    <link type="text/css" rel="stylesheet" href="http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/simple.css" />
 


<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?6bcd52f51e9b3dce32bec4a3997715ac";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

</head>
<body>


    <!-- 广告位开始 -->
        <ins data-revive-zoneid="149" data-revive-id="8c38e720de1c90a6f6ff52f3f89c4d57"></ins>
    <!-- 广告位结束 -->

    
   
      <!--new top-->
    <script id="toolbar-tpl-scriptId" fixed="true" prod="blog" skin="black" src="http://c.csdnimg.cn/public/common/toolbar/js/html.js" type="text/javascript"></script>
     <!--new top-->
    <div id="container">
        <div id="header">
    <div class="header">
        <div id="blog_title">
            <h2>
                <a href="http://blog.csdn.net/chen19870707">@Echo&#183; 个人技术笔记</a></h2>
            <h3>Echo Chen</h3>
            <div class="clear">
            </div>
        </div>
        <div class="clear">
        </div>
        
     
    </div>
</div>
<div id="navigator">
    <div class="navigator_bg">
    </div>
    <div class="navigator">
        <ul>           
                <li id="btnContents"><a href="http://blog.csdn.net/chen19870707?viewmode=contents"><span onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_mulu'])">
                    <img src="http://static.blog.csdn.net/images/ico_list.gif">目录视图</span></a></li>
                <li id="btnView"><a href="http://blog.csdn.net/chen19870707?viewmode=list"><span onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_zhaiyao'])">
                    <img src="http://static.blog.csdn.net/images/ico_summary.gif">摘要视图</span></a></li>
                <li id="btnRss"><a href="http://blog.csdn.net/chen19870707/rss/list"><span onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_RSS'])">
                    <img src="http://static.blog.csdn.net/images/ico_rss.gif">订阅</span></a></li>                
            

            </ul>
    </div>
</div>
<script type="text/javascript">
    var username = "chen19870707";
    var _blogger = username;
    var blog_address = "http://blog.csdn.net/chen19870707";
    var static_host = "http://static.blog.csdn.net";
    var currentUserName = "";  
</script>

        <div id="body">
            <div id="main">
                <div class="main">
                        <div class="ad_class">
<div class="notice tracking-ad" data-mod='popu_3' > 


<a href="http://blog.csdn.net/blogdevteam/article/details/53636007
">
<font color=blue>【获奖公布】“我的2016”主题征文活动 


</font></a>

&nbsp;&nbsp;&nbsp;&nbsp

<a href="http://bss.csdn.net/m/topic/edu_develop
">
<font color=red>程序猿全指南，让【移动开发】更简单！ 
</font></a>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<a href="http://blog.csdn.net/PK.html">
<font color=blue>【观点】移动原生App开发和HTML 5开发，你更看好哪个？
</font></a>

&nbsp;&nbsp;&nbsp;

<a href="http://blog.csdn.net/baiyuzhong2012/article/details/54098338">
<font color=red>博客的神秘功能
</font></a>


</div>                        </div>
                        



  
<link href="http://static.blog.csdn.net/css/comment1.css" type="text/css" rel="stylesheet" />
<link href="http://static.blog.csdn.net/css/style1.css" type="text/css" rel="stylesheet" />
<script language='JavaScript' type='text/javascript' src='http://download.csdn.net/js/jquery.cookie.js'></script>
<script type="text/javascript" src="http://c.csdnimg.cn/rabbit/search-service/main.js"></script>
<link rel="stylesheet" href="http://static.blog.csdn.net/public/res-min/markdown_views.css?v=1.0" />
<link rel="stylesheet" href="http://static.blog.csdn.net/css/category.css?v=1.0" />
<script type="text/javascript" src="http://static.blog.csdn.net/public/res/bower-libs/MathJax/MathJax.js?config=TeX-AMS_HTML"></script>
<script type="text/javascript" src="http://static.blog.csdn.net/scripts/web-storage-cache.min.js"></script>
<script type="text/javascript" src="http://static.blog.csdn.net/scripts/replace.min.js"></script>




  <script type="text/ecmascript">
      window.quickReplyflag = true;
           
            var isBole = false;
            
      
      var fasrc="http://my.csdn.net/my/favorite/miniadd?t=%e8%8f%9c%e9%b8%9fnginx%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90+%e6%a1%86%e6%9e%b6%e7%af%87%ef%bc%88%e4%b8%80%ef%bc%89+%e4%bb%8emain%e5%87%bd%e6%95%b0%e7%9c%8bnginx%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b&u=http://blog.csdn.net/chen19870707/article/details/41050379"

    </script>
<div id="article_details" class="details">
    <div class="article_title">   
         <span class="ico ico_type_Original"></span>


    <h1>
        <span class="link_title"><a href="/chen19870707/article/details/41050379">
        菜鸟nginx源码剖析 框架篇（一） 从main函数看nginx启动流程            
        </a></span>
    </h1>
</div>

   

        <div class="article_manage clearfix">
        <div class="article_l">
            <span class="link_categories">
            标签：
              <a href='http://www.csdn.net/tag/nginx' target=_blank onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_tag']);">nginx</a><a href='http://www.csdn.net/tag/%e6%ba%90%e7%a0%81' target=_blank onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_tag']);">源码</a><a href='http://www.csdn.net/tag/%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b' target=_blank onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_tag']);">启动流程</a><a href='http://www.csdn.net/tag/main' target=_blank onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_tag']);">main</a><a href='http://www.csdn.net/tag/c%2b%2b' target=_blank onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_tag']);">c++</a>
            </span>
        </div>
        <div class="article_r">
            <span class="link_postdate">2014-11-12 20:52</span>
            <span class="link_view" title="阅读次数">21474人阅读</span>
            <span class="link_comments" title="评论次数"> <a href="#comments" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_pinglun'])">评论</a>(5)</span>
            <span class="link_collect tracking-ad" data-mod="popu_171"> <a href="javascript:void(0);" onclick="javascript:collectArticle('%e8%8f%9c%e9%b8%9fnginx%e6%ba%90%e7%a0%81%e5%89%96%e6%9e%90+%e6%a1%86%e6%9e%b6%e7%af%87%ef%bc%88%e4%b8%80%ef%bc%89+%e4%bb%8emain%e5%87%bd%e6%95%b0%e7%9c%8bnginx%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b','41050379');return false;" title="收藏">收藏</a></span>
             <span class="link_report"> <a href="#report" onclick="javascript:report(41050379,2);return false;" title="举报">举报</a></span>

        </div>
    </div>
    <div class="embody"  style="display:none" id="embody">
        <span class="embody_t">本文章已收录于：</span>
        <div class="embody_c" id="lib" value="{&quot;err&quot;:0,&quot;msg&quot;:&quot;ok&quot;,&quot;data&quot;:[]}"></div>
    </div>
    <style type="text/css">        
            .embody{
                padding:10px 10px 10px;
                margin:0 -20px;
                border-bottom:solid 1px #ededed;                
            }
            .embody_b{
                margin:0 ;
                padding:10px 0;
            }
            .embody .embody_t,.embody .embody_c{
                display: inline-block;
                margin-right:10px;
            }
            .embody_t{
                font-size: 12px;
                color:#999;
            }
            .embody_c{
                font-size: 12px;
            }
            .embody_c img,.embody_c em{
                display: inline-block;
                vertical-align: middle;               
            }
             .embody_c img{               
                width:30px;
                height:30px;
            }
            .embody_c em{
                margin: 0 20px 0 10px;
                color:#333;
                font-style: normal;
            }
    </style>
    <script  type="text/javascript">
        $(function () {
            try
            {
                var lib = eval("("+$("#lib").attr("value")+")");
                var html = "";
                if (lib.err == 0) {
                    $.each(lib.data, function (i) {
                        var obj = lib.data[i];
                        //html += '<img src="' + obj.logo + '"/>' + obj.name + "&nbsp;&nbsp;";
                        html += ' <a href="' + obj.url + '" target="_blank">';
                        html += ' <img src="' + obj.logo + '">';
                        html += ' <em><b>' + obj.name + '</b></em>';
                        html += ' </a>';
                    });
                    if (html != "") {
                        setTimeout(function () {
                            $("#lib").html(html);                      
                            $("#embody").show();
                        }, 100);
                    }
                }      
            } catch (err)
            { }
            
        });
    </script>
      <div class="category clearfix">
        <div class="category_l">
           <img src="http://static.blog.csdn.net/images/category_icon.jpg">
            <span>分类：</span>
        </div>
        <div class="category_r">
                    <label  onclick="GetCategoryArticles('2647301','chen19870707','top','41050379');">
                        <span onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_fenlei']);">Server - 菜鸟nginx源码剖析<em>（13）</em></span>
                      <img class="arrow-down" src="http://static.blog.csdn.net/images/arrow_triangle _down.jpg" style="display:inline;">
                      <img class="arrow-up" src="http://static.blog.csdn.net/images/arrow_triangle_up.jpg" style="display:none;">
                        <div class="subItem">
                            <div class="subItem_t"><a  href="http://blog.csdn.net/chen19870707/article/category/2647301"  target="_blank">作者同类文章</a><i class="J_close">X</i></div>
                            <ul class="subItem_l" id="top_2647301">                            
                            </ul>
                        </div>
                    </label>                    
        </div>
    </div>
    <script   type="text/javascript" src="http://static.blog.csdn.net/scripts/category.js"></script>  
        <div   class="bog_copyright">         
            <p  class="copyright_p" >版权声明：本文为博主原创文章，未经博主允许不得转载。</p>
        </div>

  

  
  
     

<div id="article_content" class="article_content">

<p align="center"><span style="font-size:32px"></span>&nbsp;</p>
<p align="center"><span style="font-size:32px">菜鸟nginx源码剖析 框架篇（一） 从main函数看nginx启动流程</span></p>
<p>&nbsp;</p>
<li>
<p>Author：Echo Chen（陈斌）</p>
</li><li>
<p>Email：chenb19870707@gmail.com</p>
</li><li>
<p>Blog：<a target="_blank" target="_blank" href="http://blog.csdn.net/chen19870707">Blog.csdn.net/chen19870707</a></p>
</li><li>
<p>Date：Nov 9th, 2014</p>
<p>&nbsp;</p>
<blockquote>
<p>俗话说的好，牵牛要牵牛鼻子 驾车顶牛，处理复杂的东西，只要抓住重点，才能理清脉络，不至于深陷其中，不能自拔。对复杂的nginx而言，main函数就是“牛之鼻”，只要能理清main函数，就一定能理解其中的奥秘，下面我们就一起来研究一下nginx的main函数。</p>
</blockquote>
<h2></h2>
<h2>1.nginx的main函数解读</h2>
<blockquote>
<p>nginx启动显然是由main函数驱动的，main函数在在<a target="_blank" target="_blank" href="http://trac.nginx.org/nginx/browser/nginx/src/core/nginx.c">core/nginx.c</a>文件中，其源代码解析如下，涉及到的数据结构在本节仅指出其作用，将在第二节中详细解释。</p>
</blockquote>
</li><li>
<blockquote><strong>nginx main函数的流程图如下：</strong></blockquote>
<p><a target="_blank" target="_blank" href="http://img.blog.csdn.net/20141112205246595"><img title="image" border="0" alt="image" src="http://img.blog.csdn.net/20141112205247016" width="606" height="708" style="border-left-width:0px; border-right-width:0px; border-bottom-width:0px; float:none; padding-top:0px; padding-left:0px; margin-left:auto; display:block; padding-right:0px; border-top-width:0px; margin-right:auto"></a></p>
<blockquote>
<p><strong>需要说明的：</strong></p>
</blockquote>
</li><li>
<blockquote>
<p>1） 初始化错误提示列表，以errno为下标，元素就是对应的错误提示信息。</p>
</blockquote>
</li><li>
<blockquote>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_strerror_init() != NGX_OK) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> }</pre>
</div>
</div>
</blockquote>
<blockquote>
<p>2）获取命令行参数，保存在全局变量中，可以设置的命令行参数如下表所示:</p>
</blockquote>
</li><li>
<blockquote>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_get_options(argc, argv) != NGX_OK) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp; }</pre>
</div>
</div>
</blockquote>
<blockquote>
<blockquote><del></del>
<table cellspacing="0" cellpadding="2" width="600" border="1">
<tbody>
<tr>
<td valign="top" width="200"><strong>命令行参数</strong></td>
<td valign="top" width="400"><strong>作用</strong></td>
</tr>
<tr>
<td valign="top" width="200">-h或-？</td>
<td valign="top" width="400">显示版本信息和help信息</td>
</tr>
<tr>
<td valign="top" width="200">-v</td>
<td valign="top" width="400">显示版本信息</td>
</tr>
<tr>
<td valign="top" width="200">-V</td>
<td valign="top" width="400">显示nginx版本信息、编译器版本和配置选项信息</td>
</tr>
<tr>
<td valign="top" width="200">-t</td>
<td valign="top" width="400">测试配置文件信息是否OK，即检测配置文件语法的正确性，并尝试打开配置文件中所引用到的文件</td>
</tr>
<tr>
<td valign="top" width="200">-q</td>
<td valign="top" width="400">在测试配置文件的时候，屏蔽无错误信息，即quiet模式</td>
</tr>
<tr>
<td valign="top" width="200">-s signal</td>
<td valign="top" width="400">发送信号到master进程（如stop、quit、reopen、reload）</td>
</tr>
<tr>
<td valign="top" width="200">-p prefix</td>
<td valign="top" width="400">设置前缀路径（默认为当前目录）</td>
</tr>
<tr>
<td valign="top" width="200">-c filename</td>
<td valign="top" width="400">设置配置文件（默认为conf/nginx.conf）</td>
</tr>
<tr>
<td valign="top" width="200">-g directives</td>
<td valign="top" width="400">在配置文件外设置全局的指令</td>
</tr>
</tbody>
</table>
</blockquote>
</blockquote>
<blockquote>
<p>3）时间、正则表达式和log的初始化。</p>
</blockquote>
<ul>
</ul>
<ul>
</ul>
<ul>
</ul>
<ul>
</ul>
<ul>
</ul>
<blockquote>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> ngx_time_init();</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> (NGX_PCRE)</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span> ngx_regex_init();</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span> <span style="color:#0000ff">if</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span> ngx_pid = ngx_getpid();</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span> log = ngx_log_init(ngx_prefix);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span> <span style="color:#0000ff">if</span> (log == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span> }</pre>
</div>
</div>
</blockquote>
&nbsp; &nbsp; &nbsp;<span style="white-space:pre"> </span>&nbsp; 4) 初始化cycle结构，并创建内存块大小为1024的内存池，内存池创建已经在《<a target="_blank" target="_blank" href="http://blog.csdn.net/chen19870707/article/details/41015613">菜鸟nginx源码剖析数据结构篇（九） 内存池ngx_pool_t</a>》讨论过了，nginx框架就是围绕着ngx_cycle_t结构体来控制运行的，其定义详情请参考下一节。<br>
<blockquote>
<div>
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:rgb(96,96,96)">   1:</span> ngx_memzero(&amp;init_cycle, <span style="color:#0000ff">sizeof</span>(ngx_cycle_t));</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span> init_cycle.log = log;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> ngx_cycle = &amp;init_cycle;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span> init_cycle.pool = ngx_create_pool(1024, log);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span> <span style="color:#0000ff">if</span> (init_cycle.pool == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span> }</pre>
</div>
</div>
<div>&nbsp;</div>
<div>5)&nbsp; 将命令行参数保存到ngx_os_argv、ngx_argc以及ngx_argv这几个全局的变量中。这算是一个备份存储，方便以后master进程做热代码替换之用。</div>
</blockquote>
<blockquote>
<div>
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_save_argv(&amp;init_cycle, argc, argv) != NGX_OK) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> }</pre>
</div>
</div>
</blockquote>
<blockquote>
<div>6）用命令行参数得来的全局变量初始化cycle的conf_prefix（配置文件所在路径的前缀）、prefix（nginx可执行文件所在路径）、conf_file（配置文件名）和conf_param（通过命令行-g选项指定的全局配置信息）。</div>
</blockquote>
<blockquote>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_process_options(&amp;init_cycle) != NGX_OK) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> }</pre>
</div>
</div>
</blockquote>
<blockquote>
<div>7）&nbsp; 根据操作系统确定一些参数，信息会被保存到一些全局变量中，如页大小ngx_pagesize, CPU cacheline</div>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_os_init(log) != NGX_OK) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> }</pre>
</div>
</div>
</blockquote>
<blockquote>
<div>8) 初始化一个做循环冗余校验的表，由此可以看出后续的循环冗余校验将采用高效的查表法</div>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_crc32_table_init() != NGX_OK) {&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp; } </pre>
</div>
</div>
</blockquote>
<blockquote>
<div>9）通过环境变量NGINX完成socket的继承，继承来的socket将会放到init_cycle的listening数组中。同时可以读取master进程传递的平滑升级信息等等</div>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_add_inherited_sockets(&amp;init_cycle) != NGX_OK) {&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp; </pre>
</div>
</div>
</blockquote>
<blockquote>
<p>10）初始化所有模块的index信息，即对所有模块进行编号，ngx_modules数却是在自动编译的时候生成的，位于objs/ngx_modules.c文件中</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> ngx_max_module = 0;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span> <span style="color:#0000ff">for</span> (i = 0; ngx_modules[i]; i&#43;&#43;) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_modules[i]-&gt;index = ngx_max_module&#43;&#43;;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span> }</pre>
</div>
</div>
</blockquote>
<blockquote>
<p>11）&nbsp; 用上面收集的init_cycle信息初始化ngx_cycle，这行代码是nginx启动过程中最重要的一个步骤，在第3节将详细展开。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> cycle = ngx_init_cycle(&amp;init_cycle);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span> <span style="color:#0000ff">if</span> (cycle == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_test_config) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_stderr(0, <span style="color:#006080">&quot;configuration file %s test failed&quot;</span>,</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; init_cycle.conf_file.data);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span> }</pre>
</div>
</div>
<p>&nbsp;</p>
<p>12）ccf 为ngx_core_conf_t 将在第2节给出详细定义，这个地方需要解释下，ccf-&gt;master是从配置文件中解析master_process配置项所得的&#20540;，初始化为NGX_CONF_UNSET（-1），在配置项中，如果flag类型的配置项master_process被设置为on，则其&#20540;为1，如果为off，则其&#20540;为0，ngx_process为全局变量，用于记录要采用的工作模式，未被初始化，因此初始&#20540;是0（uint型全局变量会被系统默认初始化为0），相关宏定义如下：</p>
<ol>
<li>#define NGX_PROCESS_SINGLE&nbsp;&nbsp;&nbsp;&nbsp; 0 </li><li>#define NGX_PROCESS_MASTER&nbsp;&nbsp;&nbsp;&nbsp; 1 </li><li>#define NGX_PROCESS_SIGNALLER&nbsp; 2 </li><li>#define NGX_PROCESS_WORKER&nbsp;&nbsp;&nbsp;&nbsp; 3 </li><li>#define NGX_PROCESS_HELPER&nbsp;&nbsp;&nbsp;&nbsp; 4 </li></ol>
<p>因此，下面的if判断语句的含义就是：用来处理一种特殊情况，即如果在配置项中未设置master_process配置项或者是设置为打开，ngx_process未被设置，采用默认&#20540;0，这个时候要采用master工作模式。因为master_process优先级高，且nginx默认采用master模式如果在配置项中设置master_process为off，那么if依据不会执行。最终nginx工作模式取决于ngx_proces的初&#20540;0，即采用单进程模式。</p>
<p>&nbsp;</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> ccf = (ngx_core_conf_t *) ngx_get_conf(cycle-&gt;conf_ctx, ngx_core_module);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> <span style="color:#0000ff">if</span> (ccf-&gt;master &amp;&amp; ngx_process == NGX_PROCESS_SINGLE) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_process = NGX_PROCESS_MASTER;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span> }</pre>
</div>
</div>
</blockquote>
<blockquote>
<p>13）初始化信号；主要完成信号处理程序的注册</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_init_signals(cycle-&gt;log) != NGX_OK) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> }</pre>
</div>
</div>
</blockquote>
<blockquote>
<p>14）若无继承sockets，且设置了守护进程表示，则创建守护进程</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (!ngx_inherited &amp;&amp; ccf-&gt;daemon) {&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_daemon(cycle-&gt;log) != NGX_OK) {&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_daemonized = 1;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span>&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span>&nbsp;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_inherited) {&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_daemonized = 1;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span> }&nbsp; </pre>
</div>
</div>
</blockquote>
<blockquote>
<p>15) 创建进程记录文件；(非NGX_PROCESS_MASTER=1进程，不创建该文件)</p>
<div>
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_create_pidfile(&amp;ccf-&gt;pid, cycle-&gt;log) != NGX_OK) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> }</pre>
</div>
</div>
</blockquote>
<blockquote>
<p>16)&nbsp; 进入进程主循环，根据ngx_process确定启动单进程模式还是多进程模式。</p>
</blockquote>
<blockquote>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_process == NGX_PROCESS_SINGLE) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_single_process_cycle(cycle);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp; } <span style="color:#0000ff">else</span> {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_master_process_cycle(cycle);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp; }</pre>
</div>
</div>
</blockquote>
</li><li>
<h2>2.相关结构体</h2>
<blockquote>
<h3>2.1. ngx_module_t</h3>
<p>nginx中所有模块的类型都是ngx_module_t类型的，定义了模块的一些属性。nginx是完全模块化的，所有的组件都是模块，从而实现了nginx的高度松耦合。同时，我们在进行nginx模块开发时，也离不开这个数据结构。在上面初始化过程中的第10步就是初始化这个结构。</p>
</blockquote>
<blockquote>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">struct</span> ngx_module_s {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/**</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 在具体类型模块（http、event等）的全局配置结构数组的下标。以http module模块为例，</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * nginx把所有的http module的config信息存放在ngx_http_conf_ctx_t类型的变量中，</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 这个变量只有3个属性，分别是所有http module的main、srv、loc的config信息的数组。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 如果该模块是http module，则ctx_index是该模块的config信息（main、srv、loc）</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 在ngx_http_conf_ctx_t中的下标。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_uint_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ctx_index;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/**</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * nginx把所有模块（ngx_module_t）存放到ngx_modules数组中，这个数组在nginx源码路</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum13" style="color:#606060">  13:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 径的objs/ngx_modules.c中，是在运行configure脚本后生成的。index属性就是该模块</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum14" style="color:#606060">  14:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 在ngx_modules数组中的下标。同时nginx把所有的core module的配置结构存放到ngx_cycle的</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum15" style="color:#606060">  15:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * conf_ctx数组中，index也是该模块的配置结构在ngx_cycle-&gt;conf_ctx数组中的下标。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum16" style="color:#606060">  16:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum17" style="color:#606060">  17:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_uint_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; index;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum18" style="color:#606060">  18:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum19" style="color:#606060">  19:</span>&nbsp;&nbsp;&nbsp;&nbsp; ……</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum20" style="color:#606060">  20:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum21" style="color:#606060">  21:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/**</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum22" style="color:#606060">  22:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 模块的上下文属性，同一类型的模块的属性是相同的，比如core module的ctx是ngx_core_module_t类型。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum23" style="color:#606060">  23:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 而http module的ctx是ngx_http_moduel_t类型，event module的ctx是ngx_event_module_t类型等等。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum24" style="color:#606060">  24:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 相应类型的模块由分开处理的，比如所有的http module由ngx_http_module解析处理，而所有的event module</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum25" style="color:#606060">  25:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 由ngx_events_module解析处理。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum26" style="color:#606060">  26:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum27" style="color:#606060">  27:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">void</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *ctx;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum28" style="color:#606060">  28:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum29" style="color:#606060">  29:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/**</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum30" style="color:#606060">  30:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 该模块支持的指令的数组，最后以一个空指令结尾。ngx_commond_t的分析见下文。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum31" style="color:#606060">  31:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum32" style="color:#606060">  32:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_command_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *commands;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum33" style="color:#606060">  33:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum34" style="color:#606060">  34:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/**</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum35" style="color:#606060">  35:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 模块的类型，nginx所有的模块类型：</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum36" style="color:#606060">  36:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NGX_CORE_MODULE</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum37" style="color:#606060">  37:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NGX_CONF_MODULE</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum38" style="color:#606060">  38:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NGX_HTTP_MODULE</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum39" style="color:#606060">  39:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NGX_EVENT_MODULE</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum40" style="color:#606060">  40:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NGX_MAIL_MODULE</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum41" style="color:#606060">  41:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 这些不同的类型也指定了不同的ctx。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum42" style="color:#606060">  42:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum43" style="color:#606060">  43:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_uint_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum44" style="color:#606060">  44:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum45" style="color:#606060">  45:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/* 接下来都是一些回调函数，在nginx初始化过程的特定时间点调用 */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum46" style="color:#606060">  46:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_int_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*init_master)(ngx_log_t *log);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum47" style="color:#606060">  47:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum48" style="color:#606060">  48:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/* 初始化完所有模块后调用，在ngx_int_cycle函数（ngx_cycle.c）中 */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum49" style="color:#606060">  49:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_int_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*init_module)(ngx_cycle_t *cycle);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum50" style="color:#606060">  50:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum51" style="color:#606060">  51:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/* 初始化完worker进程后调用，在ngx_worker_process_init函数（ngx_process_cycle.c）中 */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum52" style="color:#606060">  52:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_int_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*init_process)(ngx_cycle_t *cycle);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum53" style="color:#606060">  53:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_int_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*init_thread)(ngx_cycle_t *cycle);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum54" style="color:#606060">  54:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">void</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*exit_thread)(ngx_cycle_t *cycle);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum55" style="color:#606060">  55:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">void</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*exit_process)(ngx_cycle_t *cycle);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum56" style="color:#606060">  56:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum57" style="color:#606060">  57:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">void</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (*exit_master)(ngx_cycle_t *cycle);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum58" style="color:#606060">  58:</span>&nbsp;&nbsp;&nbsp;&nbsp; ……</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum59" style="color:#606060">  59:</span> };</pre>
</div>
</div>
<div>&nbsp;</div>
</blockquote>
</li><li>
<div>模块类型和上下文属性的关系如下：</div>
<blockquote>
<li>
<div>
<div>
<table cellspacing="0" cellpadding="2" width="100%" border="1">
<tbody>
<tr>
<td valign="top"><span style="font-size:16px">模块类型(type)</span></td>
<td valign="top"><span style="font-size:16px">上下文属性类型(ctx)</span></td>
</tr>
<tr>
<td valign="top">
<div><span><span style="font-size:16px">NGX_CORE_MODULE</span></span></div>
</td>
<td valign="top">
<div><span><span style="font-size:16px">ngx_core_module_t（ngx_conf_file.h）</span></span></div>
</td>
</tr>
<tr>
<td valign="top">
<div><span><span style="font-size:16px">NGX_CONF_MODULE</span></span></div>
</td>
<td valign="top"><span style="font-size:16px">NULL</span></td>
</tr>
<tr>
<td valign="top">
<div><span><span style="font-size:16px">NGX_HTTP_MODULE</span></span></div>
</td>
<td valign="top">
<div><span><span style="font-size:16px">ngx_http_module_t（http/ngx_http_config.h）</span></span></div>
</td>
</tr>
<tr>
<td valign="top">
<div><span><span style="font-size:16px">NGX_EVENT_MODULE</span></span></div>
</td>
<td valign="top">
<div><span><span style="font-size:16px">ngx_event_module_t（event/ngx_event.h）</span></span></div>
</td>
</tr>
<tr>
<td valign="top">
<div><span><span style="font-size:16px">NGX_MAIL_MODULE</span></span></div>
</td>
<td valign="top"><span style="font-size:16px">ngx_mail_module_t（mail/ngx_mail.h）</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</li></blockquote>
<ul>
<ul>
<li>
<p>常用的模块图如下图所示：</p>
</li><li>
<p><a target="_blank" target="_blank" href="http://img.blog.csdn.net/20141112205247468"><img title="image" border="0" alt="image" src="http://img.blog.csdn.net/20141112205247905" width="806" height="728" style="border-top:0px; border-right:0px; border-bottom:0px; padding-top:0px; padding-left:0px; border-left:0px; display:inline; padding-right:0px"></a></p>
</li></ul>
</ul>
<p>&nbsp;</p>
<h3>2.2 <strong>ngx_commond_t</strong></h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_commond_t描述的是模块的配置指令，也就是出现在配置文件的指令。nginx模块支持多个配置指令，所以是以ngx_commond_t数组形式存储的。这个结构在配置文件解析和模块的配置结构信息初始化时会用到。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">struct</span> ngx_command_s {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/**</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 指令名，与配置文件中一致</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_str_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/**</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 指令的类型，以及参数的个数。这个属性有两个作用：</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp; 1. 实现只解析某个类型的指令，比如当前这个指令是event module类型的，而正在解析的是</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; http module，所以会跳过所有不是http module类型的指令。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp; 2. 实现指令参数个数的校验。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum13" style="color:#606060">  13:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_uint_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum14" style="color:#606060">  14:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum15" style="color:#606060">  15:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/*</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum16" style="color:#606060">  16:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 回调函数，在解析配置文件时，遇到这个指令时调用。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum17" style="color:#606060">  17:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * cf: 包括配置参数信息cf-&gt;args（ngx_array_t类型），以及指令对应的模块上下文cf-&gt;ctx</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum18" style="color:#606060">  18:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在解析不同模块的指令时，这个上下文信息不同。比如在解析core module时，cf-&gt;ctx</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum19" style="color:#606060">  19:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 是ngx_cycle-&gt;conf_ctx也就是所有core module的配置结构数组，而在解析http module</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum20" style="color:#606060">  20:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 时cf-&gt;ctx是ngx_http_conf_ctx_t类型的，其中包含所有http module的main、srv、loc</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum21" style="color:#606060">  21:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 的配置结构数组。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum22" style="color:#606060">  22:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * cmd: 指令对应的ngx_command_t结构。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum23" style="color:#606060">  23:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * conf：指令对应的模块的配置信息。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum24" style="color:#606060">  24:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum25" style="color:#606060">  25:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">char</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *(*set)(ngx_conf_t *cf, ngx_command_t *cmd, <span style="color:#0000ff">void</span> *conf);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum26" style="color:#606060">  26:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum27" style="color:#606060">  27:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/**</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum28" style="color:#606060">  28:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 对http module有效，http module的配置结构信息（main、srv、loc）都存放在ngx_http_conf_ctx_t</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum29" style="color:#606060">  29:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 中对应的数组，conf属性指示这个指令的配置结构是main、srv还是loc。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum30" style="color:#606060">  30:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum31" style="color:#606060">  31:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_uint_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; conf;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum32" style="color:#606060">  32:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum33" style="color:#606060">  33:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/**</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum34" style="color:#606060">  34:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 指令对应属性在模块配置结构中的偏移量。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum35" style="color:#606060">  35:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum36" style="color:#606060">  36:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_uint_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; offset;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum37" style="color:#606060">  37:</span>&nbsp;&nbsp;&nbsp;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum38" style="color:#606060">  38:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/**</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum39" style="color:#606060">  39:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; * 一般是函数指针，在set回调函数中调用。</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum40" style="color:#606060">  40:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum41" style="color:#606060">  41:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">void</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *post;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum42" style="color:#606060">  42:</span> };</pre>
</div>
</div>
<p>&nbsp;</p>
<h3><strong>2.3 ngx_cycle_t</strong></h3>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_cycle_t是nginx中最重要的数据结构，包含了全局的配置信息、所有监听的套接字、连接池、读写事件等。ngx_cycle_t相当于nginx的一个生命周期，从nginx启动后直到向nginx发送stop或者reload信号。nginx中有一个全局变量ngx_cycle指向当前的cycle。</p>
<div id="codeSnippetWrapper">&nbsp;</div>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">struct</span> ngx_cycle_s {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/*保存着所有模块存储配置项的结构体的指针，它首先是一个数组，每个数组成员又是一个指针，这个指针指向另一个存储着指针的数组*/</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">void</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ****conf_ctx;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">//内存池</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_pool_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *pool;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/*日志模块中提供了生成基本ngx_log_t日志对象的功能，这里的log实际上在还没有执行ngx_init_cycle方法前，也就是还没有解析配置前，如果有信息输出日志</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp; 就会暂时使用log对象，它会输出到屏幕。在调用ngx_int_cycle后，将会根据nginx.comfg配置文件中的配置项构造出正确的日志，此时会对log进行重新赋&#20540;*/</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *log;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/*由nginx.conf配置文件读取到日志文件路径后，将开始初始化error_log日志文件，由于log对象还在用于输出日志屏幕，这时会用new_log暂时性地替代log日志</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp; 待初始化成功后，会用new_log的地址覆盖上面的log指针*/</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new_log;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum13" style="color:#606060">  13:</span>&nbsp;&nbsp;&nbsp;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum14" style="color:#606060">  14:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_uint_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log_use_stderr;&nbsp; <span style="color:#008000">/* unsigned&nbsp; log_use_stderr:1; */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum15" style="color:#606060">  15:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">//files文件数组的个数</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum16" style="color:#606060">  16:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_uint_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; files_n;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum17" style="color:#606060">  17:</span>&nbsp;&nbsp;&nbsp; <span style="color:#008000">/*对于poll、rtsig这样的事件模块，会以有效文件句柄来预先建立这些ngx_connection_t结构体，以加速时间的收集分发，这时files就会保存所有ngx_connection_t</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum18" style="color:#606060">  18:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp; 的指针成员数组，files_n就是指针的总数，而文件句柄的&#20540;用于访问files数组成员*/</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum19" style="color:#606060">  19:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_connection_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **files;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum20" style="color:#606060">  20:</span>&nbsp;&nbsp;&nbsp; <span style="color:#008000">//可用连接池</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum21" style="color:#606060">  21:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_connection_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *free_connections;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum22" style="color:#606060">  22:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">//可用连接池中连接总数</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum23" style="color:#606060">  23:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_uint_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; free_connection_n;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum24" style="color:#606060">  24:</span>&nbsp;&nbsp;&nbsp;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum25" style="color:#606060">  25:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/*双向链表容器，元素是ngx_connection_t结构体，表示可重复使用的连接队列*/</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum26" style="color:#606060">  26:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_queue_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reusable_connections_queue;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum27" style="color:#606060">  27:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">//动态数组，每个数组元素存储着ngx_listening_t成员，表示监听端口及相关参数</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum28" style="color:#606060">  28:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_array_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; listening;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum29" style="color:#606060">  29:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">//动态数组，存储着nginx所有要操作的目录，如果目录不存在，则试图创建，创建失败会导致nginx启动失败</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum30" style="color:#606060">  30:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_array_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; paths;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum31" style="color:#606060">  31:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/*单链表容器，元素类型是nginx_open_file_t，表示已打开的所有文件。*/</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum32" style="color:#606060">  32:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp; ngx_list_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; open_files;</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum33" style="color:#606060">  33:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp; /*单链表容器，元素是ngx_shm_zone_t，每个元素表示一块共享内存*/</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum34" style="color:#606060">  34:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_list_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shared_memory;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum35" style="color:#606060">  35:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">//当前连接对象的总数</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum36" style="color:#606060">  36:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_uint_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection_n;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum37" style="color:#606060">  37:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum38" style="color:#606060">  38:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">//指向当前进程中所有连接对象</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum39" style="color:#606060">  39:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_connection_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *connections;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum40" style="color:#606060">  40:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">//指向当前进程中的所有读事件对象，connection_n同时表示所有读事件总数</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum41" style="color:#606060">  41:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_event_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *read_events;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum42" style="color:#606060">  42:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">//指向当前进程中的所有写事件对象，connection_n同时表示所有写事件总数</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum43" style="color:#606060">  43:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_event_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *write_events;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum44" style="color:#606060">  44:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">//旧的ngx_cycle_t对象用于引用上一个ngx_cycle_t对象中的成员</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum45" style="color:#606060">  45:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_cycle_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *old_cycle;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum46" style="color:#606060">  46:</span>&nbsp;&nbsp;&nbsp;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum47" style="color:#606060">  47:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_str_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; conf_file;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">// 配置文件名&nbsp; </span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum48" style="color:#606060">  48:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_str_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; conf_param;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">// 由命令行-g提供配置参数&nbsp; </span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum49" style="color:#606060">  49:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_str_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; conf_prefix;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">// 配置前缀&nbsp; </span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum50" style="color:#606060">  50:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_str_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; prefix;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">// nginx所在路径&nbsp; </span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum51" style="color:#606060">  51:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_str_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lock_file;&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum52" style="color:#606060">  52:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_str_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hostname;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">// 主机名&nbsp; </span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum53" style="color:#606060">  53:</span> };</pre>
</div>
</div>
<h2>3.ngx_init_cycle函数</h2>
<blockquote>
<p>ngx_init_cycle 初始化步骤 有以下操作，这里涉及到ngx_list_t和ngx_array_t，如果有不懂的同学请参考我之前对于这两个结构分析的文章，同时这个函数比较复杂，希望大家耐心点。</p>
<p>1） 更新时区和时间。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> ngx_timezone_update();</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> <span style="color:#008000">/* force localtime update with a new timezone */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span> tp = ngx_timeofday();</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span> tp-&gt;sec = 0;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span> ngx_time_update();</pre>
</div>
</div>
<p>&nbsp;</p>
<p>2） 创建内存池，并从内存池中创建ngx_cycle_t结构，然后给cycle日志和old_cycle赋&#20540;</p>
<p id="codeSnippetWrapper"></p>
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> log = old_cycle-&gt;log;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> pool = ngx_create_pool(NGX_CYCLE_POOL_SIZE, log);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span> <span style="color:#0000ff">if</span> (pool == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span> }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span> pool-&gt;log = log;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span> cycle = ngx_pcalloc(pool, <span style="color:#0000ff">sizeof</span>(ngx_cycle_t));</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span> <span style="color:#0000ff">if</span> (cycle == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum13" style="color:#606060">  13:</span> }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum14" style="color:#606060">  14:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum15" style="color:#606060">  15:</span> cycle-&gt;pool = pool;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum16" style="color:#606060">  16:</span> cycle-&gt;log = log;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum17" style="color:#606060">  17:</span> cycle-&gt;old_cycle = old_cycle;</pre>
</div>
<p></p>
<p>&nbsp;</p>
<p>3）根据old_cycle初始化cycle中的conf_file、conf_prefix、prefix和conf_param。</p>
<p id="codeSnippetWrapper"></p>
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> cycle-&gt;conf_prefix.len = old_cycle-&gt;conf_prefix.len;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span> cycle-&gt;conf_prefix.data = ngx_pstrdup(pool, &amp;old_cycle-&gt;conf_prefix);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> <span style="color:#0000ff">if</span> (cycle-&gt;conf_prefix.data == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span> }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span> cycle-&gt;prefix.len = old_cycle-&gt;prefix.len;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span> cycle-&gt;prefix.data = ngx_pstrdup(pool, &amp;old_cycle-&gt;prefix);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span> <span style="color:#0000ff">if</span> (cycle-&gt;prefix.data == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum13" style="color:#606060">  13:</span> }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum14" style="color:#606060">  14:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum15" style="color:#606060">  15:</span> cycle-&gt;conf_file.len = old_cycle-&gt;conf_file.len;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum16" style="color:#606060">  16:</span> cycle-&gt;conf_file.data = ngx_pnalloc(pool, old_cycle-&gt;conf_file.len &#43; 1);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum17" style="color:#606060">  17:</span> <span style="color:#0000ff">if</span> (cycle-&gt;conf_file.data == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum18" style="color:#606060">  18:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum19" style="color:#606060">  19:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum20" style="color:#606060">  20:</span> }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum21" style="color:#606060">  21:</span> ngx_cpystrn(cycle-&gt;conf_file.data, old_cycle-&gt;conf_file.data,</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum22" style="color:#606060">  22:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; old_cycle-&gt;conf_file.len &#43; 1);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum23" style="color:#606060">  23:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum24" style="color:#606060">  24:</span> cycle-&gt;conf_param.len = old_cycle-&gt;conf_param.len;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum25" style="color:#606060">  25:</span> cycle-&gt;conf_param.data = ngx_pstrdup(pool, &amp;old_cycle-&gt;conf_param);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum26" style="color:#606060">  26:</span> <span style="color:#0000ff">if</span> (cycle-&gt;conf_param.data == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum27" style="color:#606060">  27:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum28" style="color:#606060">  28:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum29" style="color:#606060">  29:</span> }</pre>
</div>
<p></p>
<p>&nbsp;</p>
<p>4）初始化pathes，pathes是一个ngx_array_t结构</p>
<p id="codeSnippetWrapper"></p>
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> n = old_cycle-&gt;paths.nelts ? old_cycle-&gt;paths.nelts : 10;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> cycle-&gt;paths.elts = ngx_pcalloc(pool, n * <span style="color:#0000ff">sizeof</span>(ngx_path_t *));</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span> <span style="color:#0000ff">if</span> (cycle-&gt;paths.elts == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span> }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span> cycle-&gt;paths.nelts = 0;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span> cycle-&gt;paths.size = <span style="color:#0000ff">sizeof</span>(ngx_path_t *);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span> cycle-&gt;paths.nalloc = n;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span> cycle-&gt;paths.pool = pool;</pre>
</div>
<p></p>
<p>&nbsp;</p>
<p>5） 根据old_cycle的open_files的大小，初始化openfiles , openfiles为ngx_list_t</p>
<p id="codeSnippetWrapper"></p>
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (old_cycle-&gt;open_files.part.nelts) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; n = old_cycle-&gt;open_files.part.nelts;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (part = old_cycle-&gt;open_files.part.next; part; part = part-&gt;next) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n &#43;= part-&gt;nelts;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span> } <span style="color:#0000ff">else</span> {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span>&nbsp;&nbsp;&nbsp;&nbsp; n = 20;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span> }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span> <span style="color:#0000ff">if</span> (ngx_list_init(&amp;cycle-&gt;open_files, pool, n, <span style="color:#0000ff">sizeof</span>(ngx_open_file_t))</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span>&nbsp;&nbsp;&nbsp;&nbsp; != NGX_OK)</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum13" style="color:#606060">  13:</span> {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum14" style="color:#606060">  14:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum15" style="color:#606060">  15:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum16" style="color:#606060">  16:</span> }</pre>
</div>
<p></p>
<p><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6） 根据old_cycle的shared_memory的大小初始化shared_memory（ngx_list_t）。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (old_cycle-&gt;shared_memory.part.nelts) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; n = old_cycle-&gt;shared_memory.part.nelts;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (part = old_cycle-&gt;shared_memory.part.next; part; part = part-&gt;next)</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n &#43;= part-&gt;nelts;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span> } <span style="color:#0000ff">else</span> {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span>&nbsp;&nbsp;&nbsp;&nbsp; n = 1;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span> }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span> <span style="color:#0000ff">if</span> (ngx_list_init(&amp;cycle-&gt;shared_memory, pool, n, <span style="color:#0000ff">sizeof</span>(ngx_shm_zone_t))</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum13" style="color:#606060">  13:</span>&nbsp;&nbsp;&nbsp;&nbsp; != NGX_OK)</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum14" style="color:#606060">  14:</span> {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum15" style="color:#606060">  15:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum16" style="color:#606060">  16:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum17" style="color:#606060">  17:</span> }</pre>
</div>
</div>
<p><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 7） 根据old_cycle的listenning大小初始化listening（ngx_array_t）。</p>
<p id="codeSnippetWrapper"></p>
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> n = old_cycle-&gt;listening.nelts ? old_cycle-&gt;listening.nelts : 10;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span> cycle-&gt;listening.elts = ngx_pcalloc(pool, n * <span style="color:#0000ff">sizeof</span>(ngx_listening_t));</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span> <span style="color:#0000ff">if</span> (cycle-&gt;listening.elts == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span> }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span> cycle-&gt;listening.nelts = 0;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span> cycle-&gt;listening.size = <span style="color:#0000ff">sizeof</span>(ngx_listening_t);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span> cycle-&gt;listening.nalloc = n;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span> cycle-&gt;listening.pool = pool;</pre>
</div>
<p></p>
<p><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 8） 初始化conf_ctx（void ****）数组，大小是ngx_max_module，用于存储所有core module的配置结构信息。 <br>
</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> cycle-&gt;conf_ctx = ngx_pcalloc(pool, ngx_max_module * <span style="color:#0000ff">sizeof</span>(<span style="color:#0000ff">void</span> *));</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (cycle-&gt;conf_ctx == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp; }</pre>
</div>
</div>
<p></p>
<p>&nbsp;</p>
<p>9） 调用系统调用gethostname获取主机名，初始化hostname。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4">
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (gethostname(hostname, NGX_MAXHOSTNAMELEN) == -1) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_error(NGX_LOG_EMERG, log, ngx_errno, <span style="color:#006080">&quot;gethostname() failed&quot;</span>);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum5" style="color:#606060">   5:</span>&nbsp; }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum6" style="color:#606060">   6:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum7" style="color:#606060">   7:</span>&nbsp; <span style="color:#008000">/* on Linux gethostname() silently truncates name that does not fit */</span></pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum8" style="color:#606060">   8:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum9" style="color:#606060">   9:</span>&nbsp; hostname[NGX_MAXHOSTNAMELEN - 1] = <span style="color:#006080">'\0'</span>;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum10" style="color:#606060">  10:</span>&nbsp; cycle-&gt;hostname.len = ngx_strlen(hostname);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum11" style="color:#606060">  11:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum12" style="color:#606060">  12:</span>&nbsp; cycle-&gt;hostname.data = ngx_pnalloc(pool, cycle-&gt;hostname.len);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum13" style="color:#606060">  13:</span>&nbsp; <span style="color:#0000ff">if</span> (cycle-&gt;hostname.data == NULL) {</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum14" style="color:#606060">  14:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum15" style="color:#606060">  15:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum16" style="color:#606060">  16:</span>&nbsp; }</pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum17" style="color:#606060">  17:</span>&nbsp; </pre>
<pre style="border-top-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; border-bottom-style:none; color:black; padding-bottom:0px; direction:ltr; text-align:left; padding-top:0px; border-right-style:none; padding-left:0px; margin:0em; border-left-style:none; line-height:12pt; padding-right:0px; background-color:#f4f4f4"><span id="lnum18" style="color:#606060">  18:</span>&nbsp; ngx_strlow(cycle-&gt;hostname.data, (u_char *) hostname, cycle-&gt;hostname.len);</pre>
</div>
</div>
</blockquote>
<p>&nbsp;</p>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10）调用所有core module的create_conf回调函数创建该core module的配置信息结构，并且更新cycle-&gt;conf_ctx数组，<br>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nginx的core module主要有：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_core_module（core/nginx.c）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_http_module（http/ngx_http.c）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_events_module（event/ngx_event.c）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_errlog_module（core/ngx_log.c）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_mail_module（mail/ngx_mail.c）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_openssl_module（event/ngx_event_openssl.c）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_google_perftools_module（misc/ngx_google_perftools_module.c）</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 只有ngx_core_module和ngx_google_perftools_module两个模块有定义create_conf，而ngx_google_perftools_module仅用于性能测试，所以真正使用时只有ngx_core_module有create_conf回调函数。这个会调用函数会创建ngx_core_conf_t结构，用于存储整个配置文件main scope范围内的信息，比如worker_processes，worker_cpu_affinity等。</p>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum1" style="color:rgb(96,96,96)">   1:</span> <span style="color:#0000ff">for</span> (i = 0; ngx_modules[i]; i&#43;&#43;) {</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_modules[i]-&gt;type != NGX_CORE_MODULE) {</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum5" style="color:#606060">   5:</span>&nbsp; </pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp;&nbsp; module = ngx_modules[i]-&gt;ctx;</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum7" style="color:#606060">   7:</span>&nbsp; </pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum8" style="color:#606060">   8:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (module-&gt;create_conf) {</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum9" style="color:#606060">   9:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rv = module-&gt;create_conf(cycle);</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum10" style="color:#606060">  10:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (rv == NULL) {</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum11" style="color:#606060">  11:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum12" style="color:#606060">  12:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum13" style="color:#606060">  13:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum14" style="color:#606060">  14:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cycle-&gt;conf_ctx[ngx_modules[i]-&gt;index] = rv;</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum15" style="color:#606060">  15:</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="font-size:8pt; line-height:12pt; border-style:none; overflow:visible; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; background-color:rgb(244,244,244)"><span id="lnum16" style="color:#606060">  16:</span> }</pre>
<blockquote>
<p>11）初始化ngx_conf_t，用于解析配置文件并保存解析出来的信息。args是配置文件中指令的信息的数组，args[0]是指令名，args[1] - args[n]是指令的参数，参数个数需要根据ngx_commond_t的type属性做校验。ngx_conf_t中的module_type和cmd_type用于控制解析什么类型的指令，module_type表示只解析该类型模块包含的指令，cmd_type表示将要解析的指令的类型，也就是说只有符合module_type和cmd_type的指令才会被解析。比如module_type取NGX_HTTP_MODULE，而cmd_type取NGX_HTTP_SRV_CONF，那么在一次配置文件解析中，只会对http
 module的server块的指令进行解析。</p>
</blockquote>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; line-height:12pt; background-color:rgb(244,244,244)">
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum1" style="color:#606060">   1:</span> ngx_memzero(&amp;conf, <span style="color:#0000ff">sizeof</span>(ngx_conf_t));</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span> <span style="color:#008000">/* STUB: init array ? */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span> conf.args = ngx_array_create(pool, 10, <span style="color:#0000ff">sizeof</span>(ngx_str_t));</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum4" style="color:#606060">   4:</span> <span style="color:#0000ff">if</span> (conf.args == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum7" style="color:#606060">   7:</span> }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum8" style="color:#606060">   8:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum9" style="color:#606060">   9:</span> conf.temp_pool = ngx_create_pool(NGX_CYCLE_POOL_SIZE, log);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum10" style="color:#606060">  10:</span> <span style="color:#0000ff">if</span> (conf.temp_pool == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum11" style="color:#606060">  11:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(pool);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum12" style="color:#606060">  12:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum13" style="color:#606060">  13:</span> }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum14" style="color:#606060">  14:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum15" style="color:#606060">  15:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum16" style="color:#606060">  16:</span> conf.ctx = cycle-&gt;conf_ctx;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum17" style="color:#606060">  17:</span> conf.cycle = cycle;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum18" style="color:#606060">  18:</span> conf.pool = pool;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum19" style="color:#606060">  19:</span> conf.log = log;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum20" style="color:#606060">  20:</span> conf.module_type = NGX_CORE_MODULE;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum21" style="color:#606060">  21:</span> conf.cmd_type = NGX_MAIN_CONF;</pre>
</div>
</div>
<p>&nbsp;</p>
<p>12）&nbsp; 对通过nginx -g xxx 设置的全局配置指令初始化、解析。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; line-height:12pt; background-color:rgb(244,244,244)">
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_conf_param(&amp;conf) != NGX_CONF_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; environ = senv;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_cycle_pools(&amp;conf);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum5" style="color:#606060">   5:</span> }</pre>
</div>
</div>
<p>&nbsp;</p>
<p>13）解析配置文件。配置文件的解析类&#20284;一棵树的遍历，nginx中的指令分为块指令和普通指令，每个块指令对应一棵子树，比如http块和event块。由这些块指令负责调用ngx_conf_parse函数解析块内部的指令。配置文件的具体分析会另开一片文章，这里忽略这些细节。在ngx_conf_parse函数返回后，整个配置文件解析完毕，所有模块的指令已经初始化，也就意味着所有模块基本上都初始化完，实际上ngx_conf_parse函数后面隐藏了大量的信息，包括http模块的初始化和事件模块的初始化。关于http的初始化我们后面再详细描述，这里接着讲述ngx_init_cycle。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; line-height:12pt; background-color:rgb(244,244,244)">
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_conf_parse(&amp;conf, &amp;cycle-&gt;conf_file) != NGX_CONF_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; environ = senv;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_cycle_pools(&amp;conf);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum5" style="color:#606060">   5:</span> }</pre>
</div>
</div>
<p>&nbsp;</p>
<p>14）初始化所有core module模块的config结构调用ngx_core_module_t的init_conf 。在所有core module中，只有ngx_core_module有init_conf回调，用于对ngx_core_conf_t中没有配置的字段设置默认&#20540;。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; line-height:12pt; background-color:rgb(244,244,244)">
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">for</span> (i = 0; ngx_modules[i]; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_modules[i]-&gt;type != NGX_CORE_MODULE) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum5" style="color:#606060">   5:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp;&nbsp; module = ngx_modules[i]-&gt;ctx;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum7" style="color:#606060">   7:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum8" style="color:#606060">   8:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (module-&gt;init_conf) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum9" style="color:#606060">   9:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (module-&gt;init_conf(cycle, cycle-&gt;conf_ctx[ngx_modules[i]-&gt;index])</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum10" style="color:#606060">  10:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; == NGX_CONF_ERROR)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum11" style="color:#606060">  11:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum12" style="color:#606060">  12:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; environ = senv;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum13" style="color:#606060">  13:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_cycle_pools(&amp;conf);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum14" style="color:#606060">  14:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum15" style="color:#606060">  15:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum16" style="color:#606060">  16:</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum17" style="color:#606060">  17:</span> }</pre>
</div>
</div>
<p>&nbsp;</p>
<p>15） 创建nginx的pid文件。创建所有的文件路径、打开文件描述符以及创建共享内存。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; line-height:12pt; background-color:rgb(244,244,244)">
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_test_config) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_create_pidfile(&amp;ccf-&gt;pid, log) != NGX_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum6" style="color:#606060">   6:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum7" style="color:#606060">   7:</span>&nbsp; } <span style="color:#0000ff">else</span>&nbsp;<span style="color:#0000ff">if</span> (!ngx_is_init_cycle(old_cycle)) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum8" style="color:#606060">   8:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum9" style="color:#606060">   9:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/*</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum10" style="color:#606060">  10:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * we do not create the pid file in the first ngx_init_cycle() call</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum11" style="color:#606060">  11:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * because we need to write the demonized process pid</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum12" style="color:#606060">  12:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum13" style="color:#606060">  13:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum14" style="color:#606060">  14:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; old_ccf = (ngx_core_conf_t *) ngx_get_conf(old_cycle-&gt;conf_ctx,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum15" style="color:#606060">  15:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_core_module);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum16" style="color:#606060">  16:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ccf-&gt;pid.len != old_ccf-&gt;pid.len</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum17" style="color:#606060">  17:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; || ngx_strcmp(ccf-&gt;pid.data, old_ccf-&gt;pid.data) != 0)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum18" style="color:#606060">  18:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum19" style="color:#606060">  19:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/* new pid file name */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum20" style="color:#606060">  20:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum21" style="color:#606060">  21:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_create_pidfile(&amp;ccf-&gt;pid, log) != NGX_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum22" style="color:#606060">  22:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum23" style="color:#606060">  23:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum24" style="color:#606060">  24:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum25" style="color:#606060">  25:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_delete_pidfile(old_cycle);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum26" style="color:#606060">  26:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum27" style="color:#606060">  27:</span>&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum28" style="color:#606060">  28:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum29" style="color:#606060">  29:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum30" style="color:#606060">  30:</span>&nbsp; <span style="color:#0000ff">if</span> (ngx_test_lockfile(cycle-&gt;lock_file.data, log) != NGX_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum31" style="color:#606060">  31:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum32" style="color:#606060">  32:</span>&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum33" style="color:#606060">  33:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum34" style="color:#606060">  34:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum35" style="color:#606060">  35:</span>&nbsp; <span style="color:#0000ff">if</span> (ngx_create_paths(cycle, ccf-&gt;user) != NGX_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum36" style="color:#606060">  36:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum37" style="color:#606060">  37:</span>&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum38" style="color:#606060">  38:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum39" style="color:#606060">  39:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum40" style="color:#606060">  40:</span>&nbsp; <span style="color:#0000ff">if</span> (ngx_log_open_default(cycle) != NGX_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum41" style="color:#606060">  41:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum42" style="color:#606060">  42:</span>&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum43" style="color:#606060">  43:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum44" style="color:#606060">  44:</span>&nbsp; <span style="color:#008000">/* open the new files */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum45" style="color:#606060">  45:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum46" style="color:#606060">  46:</span>&nbsp; part = &amp;cycle-&gt;open_files.part;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum47" style="color:#606060">  47:</span>&nbsp; file = part-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum48" style="color:#606060">  48:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum49" style="color:#606060">  49:</span>&nbsp; <span style="color:#0000ff">for</span> (i = 0; <span style="color:#008000">/* void */</span> ; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum50" style="color:#606060">  50:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum51" style="color:#606060">  51:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (i &gt;= part-&gt;nelts) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum52" style="color:#606060">  52:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (part-&gt;next == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum53" style="color:#606060">  53:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">break</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum54" style="color:#606060">  54:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum55" style="color:#606060">  55:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = part-&gt;next;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum56" style="color:#606060">  56:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file = part-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum57" style="color:#606060">  57:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i = 0;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum58" style="color:#606060">  58:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum59" style="color:#606060">  59:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum60" style="color:#606060">  60:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (file[i].name.len == 0) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum61" style="color:#606060">  61:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum62" style="color:#606060">  62:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum63" style="color:#606060">  63:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum64" style="color:#606060">  64:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file[i].fd = ngx_open_file(file[i].name.data,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum65" style="color:#606060">  65:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NGX_FILE_APPEND,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum66" style="color:#606060">  66:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NGX_FILE_CREATE_OR_OPEN,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum67" style="color:#606060">  67:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NGX_FILE_DEFAULT_ACCESS);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum68" style="color:#606060">  68:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum69" style="color:#606060">  69:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_debug3(NGX_LOG_DEBUG_CORE, log, 0,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum70" style="color:#606060">  70:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#006080">&quot;log: %p %d \&quot;%s\&quot;&quot;</span>,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum71" style="color:#606060">  71:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;file[i], file[i].fd, file[i].name.data);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum72" style="color:#606060">  72:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum73" style="color:#606060">  73:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (file[i].fd == NGX_INVALID_FILE) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum74" style="color:#606060">  74:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum75" style="color:#606060">  75:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_open_file_n <span style="color:#006080">&quot; \&quot;%s\&quot; failed&quot;</span>,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum76" style="color:#606060">  76:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file[i].name.data);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum77" style="color:#606060">  77:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum78" style="color:#606060">  78:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum79" style="color:#606060">  79:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum80" style="color:#606060">  80:</span>&nbsp; !(NGX_WIN32)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum81" style="color:#606060">  81:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (fcntl(file[i].fd, F_SETFD, FD_CLOEXEC) == -1) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum82" style="color:#606060">  82:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum83" style="color:#606060">  83:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#006080">&quot;fcntl(FD_CLOEXEC) \&quot;%s\&quot; failed&quot;</span>,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum84" style="color:#606060">  84:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file[i].name.data);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum85" style="color:#606060">  85:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum86" style="color:#606060">  86:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum87" style="color:#606060">  87:</span> dif</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum88" style="color:#606060">  88:</span>&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum89" style="color:#606060">  89:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum90" style="color:#606060">  90:</span>&nbsp; cycle-&gt;log = &amp;cycle-&gt;new_log;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum91" style="color:#606060">  91:</span>&nbsp; pool-&gt;log = &amp;cycle-&gt;new_log;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum92" style="color:#606060">  92:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum93" style="color:#606060">  93:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum94" style="color:#606060">  94:</span>&nbsp; <span style="color:#008000">/* create shared memory */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum95" style="color:#606060">  95:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum96" style="color:#606060">  96:</span>&nbsp; part = &amp;cycle-&gt;shared_memory.part;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum97" style="color:#606060">  97:</span>&nbsp; shm_zone = part-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum98" style="color:#606060">  98:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum99" style="color:#606060">  99:</span>&nbsp; <span style="color:#0000ff">for</span> (i = 0; <span style="color:#008000">/* void */</span> ; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum100" style="color:#606060"> 100:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum101" style="color:#606060"> 101:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (i &gt;= part-&gt;nelts) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum102" style="color:#606060"> 102:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (part-&gt;next == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum103" style="color:#606060"> 103:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">break</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum104" style="color:#606060"> 104:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum105" style="color:#606060"> 105:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = part-&gt;next;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum106" style="color:#606060"> 106:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shm_zone = part-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum107" style="color:#606060"> 107:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i = 0;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum108" style="color:#606060"> 108:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum109" style="color:#606060"> 109:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum110" style="color:#606060"> 110:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (shm_zone[i].shm.size == 0) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum111" style="color:#606060"> 111:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_error(NGX_LOG_EMERG, log, 0,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum112" style="color:#606060"> 112:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#006080">&quot;zero size shared memory zone \&quot;%V\&quot;&quot;</span>,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum113" style="color:#606060"> 113:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;shm_zone[i].shm.name);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum114" style="color:#606060"> 114:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum115" style="color:#606060"> 115:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum116" style="color:#606060"> 116:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum117" style="color:#606060"> 117:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shm_zone[i].shm.log = cycle-&gt;log;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum118" style="color:#606060"> 118:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum119" style="color:#606060"> 119:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; opart = &amp;old_cycle-&gt;shared_memory.part;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum120" style="color:#606060"> 120:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; oshm_zone = opart-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum121" style="color:#606060"> 121:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum122" style="color:#606060"> 122:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (n = 0; <span style="color:#008000">/* void */</span> ; n&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum123" style="color:#606060"> 123:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum124" style="color:#606060"> 124:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (n &gt;= opart-&gt;nelts) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum125" style="color:#606060"> 125:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (opart-&gt;next == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum126" style="color:#606060"> 126:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">break</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum127" style="color:#606060"> 127:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum128" style="color:#606060"> 128:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; opart = opart-&gt;next;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum129" style="color:#606060"> 129:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; oshm_zone = opart-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum130" style="color:#606060"> 130:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n = 0;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum131" style="color:#606060"> 131:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum132" style="color:#606060"> 132:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum133" style="color:#606060"> 133:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (shm_zone[i].shm.name.len != oshm_zone[n].shm.name.len) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum134" style="color:#606060"> 134:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum135" style="color:#606060"> 135:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum136" style="color:#606060"> 136:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum137" style="color:#606060"> 137:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_strncmp(shm_zone[i].shm.name.data,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum138" style="color:#606060"> 138:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; oshm_zone[n].shm.name.data,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum139" style="color:#606060"> 139:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shm_zone[i].shm.name.len)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum140" style="color:#606060"> 140:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; != 0)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum141" style="color:#606060"> 141:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum142" style="color:#606060"> 142:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum143" style="color:#606060"> 143:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum144" style="color:#606060"> 144:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum145" style="color:#606060"> 145:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (shm_zone[i].tag == oshm_zone[n].tag</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum146" style="color:#606060"> 146:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;&amp; shm_zone[i].shm.size == oshm_zone[n].shm.size)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum147" style="color:#606060"> 147:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum148" style="color:#606060"> 148:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shm_zone[i].shm.addr = oshm_zone[n].shm.addr;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum149" style="color:#606060"> 149:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum150" style="color:#606060"> 150:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (shm_zone[i].init(&amp;shm_zone[i], oshm_zone[n].data)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum151" style="color:#606060"> 151:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; != NGX_OK)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum152" style="color:#606060"> 152:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum153" style="color:#606060"> 153:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum154" style="color:#606060"> 154:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum155" style="color:#606060"> 155:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum156" style="color:#606060"> 156:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> shm_zone_found;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum157" style="color:#606060"> 157:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum158" style="color:#606060"> 158:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum159" style="color:#606060"> 159:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_shm_free(&amp;oshm_zone[n].shm);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum160" style="color:#606060"> 160:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum161" style="color:#606060"> 161:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">break</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum162" style="color:#606060"> 162:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum163" style="color:#606060"> 163:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum164" style="color:#606060"> 164:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_shm_alloc(&amp;shm_zone[i].shm) != NGX_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum165" style="color:#606060"> 165:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum166" style="color:#606060"> 166:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum167" style="color:#606060"> 167:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum168" style="color:#606060"> 168:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_init_zone_pool(cycle, &amp;shm_zone[i]) != NGX_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum169" style="color:#606060"> 169:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum170" style="color:#606060"> 170:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum171" style="color:#606060"> 171:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum172" style="color:#606060"> 172:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (shm_zone[i].init(&amp;shm_zone[i], NULL) != NGX_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum173" style="color:#606060"> 173:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum174" style="color:#606060"> 174:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum175" style="color:#606060"> 175:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum176" style="color:#606060"> 176:</span>&nbsp; shm_zone_found:</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum177" style="color:#606060"> 177:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum178" style="color:#606060"> 178:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum179" style="color:#606060"> 179:</span>&nbsp; }</pre>
</div>
</div>
<blockquote>
<p>16）处理监听socket的，如果监听地址相同的话，则把新、旧cycle的监听socket合并</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; line-height:12pt; background-color:rgb(244,244,244)">
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (old_cycle-&gt;listening.nelts) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ls = old_cycle-&gt;listening.elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (i = 0; i &lt; old_cycle-&gt;listening.nelts; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ls[i].remain = 0;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum6" style="color:#606060">   6:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum7" style="color:#606060">   7:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nls = cycle-&gt;listening.elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum8" style="color:#606060">   8:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (n = 0; n &lt; cycle-&gt;listening.nelts; n&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum9" style="color:#606060">   9:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum10" style="color:#606060">  10:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (i = 0; i &lt; old_cycle-&gt;listening.nelts; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum11" style="color:#606060">  11:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ls[i].ignore) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum12" style="color:#606060">  12:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum13" style="color:#606060">  13:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum14" style="color:#606060">  14:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum15" style="color:#606060">  15:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_cmp_sockaddr(nls[n].sockaddr, nls[n].socklen,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum16" style="color:#606060">  16:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ls[i].sockaddr, ls[i].socklen, 1)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum17" style="color:#606060">  17:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; == NGX_OK)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum18" style="color:#606060">  18:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum19" style="color:#606060">  19:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nls[n].fd = ls[i].fd;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum20" style="color:#606060">  20:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nls[n].previous = &amp;ls[i];</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum21" style="color:#606060">  21:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ls[i].remain = 1;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum22" style="color:#606060">  22:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum23" style="color:#606060">  23:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ls[i].backlog != nls[n].backlog) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum24" style="color:#606060">  24:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nls[n].listen = 1;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum25" style="color:#606060">  25:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum26" style="color:#606060">  26:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">break</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum27" style="color:#606060">  27:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum28" style="color:#606060">  28:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum29" style="color:#606060">  29:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum30" style="color:#606060">  30:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (nls[n].fd == (ngx_socket_t) -1) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum31" style="color:#606060">  31:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nls[n].open = 1;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum32" style="color:#606060">  32:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum33" style="color:#606060">  33:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum34" style="color:#606060">  34:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum35" style="color:#606060">  35:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum36" style="color:#606060">  36:</span>&nbsp;&nbsp;&nbsp;&nbsp; } <span style="color:#0000ff">else</span> {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum37" style="color:#606060">  37:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ls = cycle-&gt;listening.elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum38" style="color:#606060">  38:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (i = 0; i &lt; cycle-&gt;listening.nelts; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum39" style="color:#606060">  39:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ls[i].open = 1;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum40" style="color:#606060">  40:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum41" style="color:#606060">  41:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum42" style="color:#606060">  42:</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
</div>
</div>
</blockquote>
<blockquote>
<p>17）打开所有的监听socket，具体过程和用socket编程时是一样的，调用socket创建套接字 -&gt; 调用setsockopt设置成可重用socket -&gt; 设置成非阻塞socket -&gt; 调用bind绑定要监听的socket地址 -&gt; 调用listen转化成监听socket。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; line-height:12pt; background-color:rgb(244,244,244)">
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (ngx_open_listening_sockets(cycle) != NGX_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> failed;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp; }</pre>
</div>
</div>
</blockquote>
<blockquote>
<p>18）&nbsp; 根据cycle配置所有的监听socket，包括设置监听socket的接收缓冲区大小、发送缓冲区大小以及accept filter等</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; line-height:12pt; background-color:rgb(244,244,244)">
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">if</span> (!ngx_test_config) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; ngx_configure_listening_sockets(cycle);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span> }</pre>
</div>
</div>
</blockquote>
<blockquote>
<p>19）&nbsp; 调用所有模块的init_module回调函数，进行模块的初始化动作。</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; line-height:12pt; background-color:rgb(244,244,244)">
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#0000ff">for</span> (i = 0; ngx_modules[i]; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_modules[i]-&gt;init_module) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_modules[i]-&gt;init_module(cycle) != NGX_OK) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum4" style="color:#606060">   4:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/* fatal */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit(1);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum7" style="color:#606060">   7:</span>&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum8" style="color:#606060">   8:</span> }</pre>
</div>
</div>
<p>20) ngx_init_cycle最后部分代码主要就是释放多余的资源，包括关闭共享内存、监听socket已经打开的文件等，然后ngx_init_cycle正常返回</p>
<div id="codeSnippetWrapper">
<div id="codeSnippet" style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; line-height:12pt; background-color:rgb(244,244,244)">
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum1" style="color:#606060">   1:</span> <span style="color:#008000">/* close and delete stuff that lefts from an old cycle */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum2" style="color:#606060">   2:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum3" style="color:#606060">   3:</span>&nbsp;&nbsp;&nbsp; <span style="color:#008000">/* free the unnecessary shared memory */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum4" style="color:#606060">   4:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum5" style="color:#606060">   5:</span>&nbsp;&nbsp;&nbsp; opart = &amp;old_cycle-&gt;shared_memory.part;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum6" style="color:#606060">   6:</span>&nbsp;&nbsp;&nbsp; oshm_zone = opart-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum7" style="color:#606060">   7:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum8" style="color:#606060">   8:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (i = 0; <span style="color:#008000">/* void */</span> ; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum9" style="color:#606060">   9:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum10" style="color:#606060">  10:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (i &gt;= opart-&gt;nelts) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum11" style="color:#606060">  11:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (opart-&gt;next == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum12" style="color:#606060">  12:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> old_shm_zone_done;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum13" style="color:#606060">  13:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum14" style="color:#606060">  14:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; opart = opart-&gt;next;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum15" style="color:#606060">  15:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; oshm_zone = opart-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum16" style="color:#606060">  16:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i = 0;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum17" style="color:#606060">  17:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum18" style="color:#606060">  18:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum19" style="color:#606060">  19:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = &amp;cycle-&gt;shared_memory.part;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum20" style="color:#606060">  20:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shm_zone = part-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum21" style="color:#606060">  21:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum22" style="color:#606060">  22:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (n = 0; <span style="color:#008000">/* void */</span> ; n&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum23" style="color:#606060">  23:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum24" style="color:#606060">  24:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (n &gt;= part-&gt;nelts) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum25" style="color:#606060">  25:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (part-&gt;next == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum26" style="color:#606060">  26:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">break</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum27" style="color:#606060">  27:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum28" style="color:#606060">  28:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = part-&gt;next;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum29" style="color:#606060">  29:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shm_zone = part-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum30" style="color:#606060">  30:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n = 0;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum31" style="color:#606060">  31:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum32" style="color:#606060">  32:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum33" style="color:#606060">  33:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (oshm_zone[i].shm.name.len == shm_zone[n].shm.name.len</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum34" style="color:#606060">  34:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;&amp; ngx_strncmp(oshm_zone[i].shm.name.data,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum35" style="color:#606060">  35:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shm_zone[n].shm.name.data,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum36" style="color:#606060">  36:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; oshm_zone[i].shm.name.len)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum37" style="color:#606060">  37:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; == 0)</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum38" style="color:#606060">  38:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum39" style="color:#606060">  39:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">goto</span> live_shm_zone;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum40" style="color:#606060">  40:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum41" style="color:#606060">  41:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum42" style="color:#606060">  42:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum43" style="color:#606060">  43:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_shm_free(&amp;oshm_zone[i].shm);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum44" style="color:#606060">  44:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum45" style="color:#606060">  45:</span>&nbsp;&nbsp;&nbsp; live_shm_zone:</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum46" style="color:#606060">  46:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum47" style="color:#606060">  47:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum48" style="color:#606060">  48:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum49" style="color:#606060">  49:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum50" style="color:#606060">  50:</span> ld_shm_zone_done:</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum51" style="color:#606060">  51:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum52" style="color:#606060">  52:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum53" style="color:#606060">  53:</span>&nbsp;&nbsp;&nbsp; <span style="color:#008000">/* close the unnecessary listening sockets */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum54" style="color:#606060">  54:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum55" style="color:#606060">  55:</span>&nbsp;&nbsp;&nbsp; ls = old_cycle-&gt;listening.elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum56" style="color:#606060">  56:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (i = 0; i &lt; old_cycle-&gt;listening.nelts; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum57" style="color:#606060">  57:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum58" style="color:#606060">  58:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ls[i].remain || ls[i].fd == (ngx_socket_t) -1) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum59" style="color:#606060">  59:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum60" style="color:#606060">  60:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum61" style="color:#606060">  61:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum62" style="color:#606060">  62:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_close_socket(ls[i].fd) == -1) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum63" style="color:#606060">  63:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_error(NGX_LOG_EMERG, log, ngx_socket_errno,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum64" style="color:#606060">  64:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_close_socket_n <span style="color:#006080">&quot; listening socket on %V failed&quot;</span>,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum65" style="color:#606060">  65:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;ls[i].addr_text);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum66" style="color:#606060">  66:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum67" style="color:#606060">  67:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum68" style="color:#606060">  68:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum69" style="color:#606060">  69:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum70" style="color:#606060">  70:</span>&nbsp;&nbsp;&nbsp; <span style="color:#008000">/* close the unnecessary open files */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum71" style="color:#606060">  71:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum72" style="color:#606060">  72:</span>&nbsp;&nbsp;&nbsp; part = &amp;old_cycle-&gt;open_files.part;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum73" style="color:#606060">  73:</span>&nbsp;&nbsp;&nbsp; file = part-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum74" style="color:#606060">  74:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum75" style="color:#606060">  75:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (i = 0; <span style="color:#008000">/* void */</span> ; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum76" style="color:#606060">  76:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum77" style="color:#606060">  77:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (i &gt;= part-&gt;nelts) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum78" style="color:#606060">  78:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (part-&gt;next == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum79" style="color:#606060">  79:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">break</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum80" style="color:#606060">  80:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum81" style="color:#606060">  81:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = part-&gt;next;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum82" style="color:#606060">  82:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file = part-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum83" style="color:#606060">  83:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i = 0;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum84" style="color:#606060">  84:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum85" style="color:#606060">  85:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum86" style="color:#606060">  86:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (file[i].fd == NGX_INVALID_FILE || file[i].fd == ngx_stderr) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum87" style="color:#606060">  87:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum88" style="color:#606060">  88:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum89" style="color:#606060">  89:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum90" style="color:#606060">  90:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_close_file(file[i].fd) == NGX_FILE_ERROR) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum91" style="color:#606060">  91:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum92" style="color:#606060">  92:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_close_file_n <span style="color:#006080">&quot; \&quot;%s\&quot; failed&quot;</span>,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum93" style="color:#606060">  93:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file[i].name.data);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum94" style="color:#606060">  94:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum95" style="color:#606060">  95:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum96" style="color:#606060">  96:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum97" style="color:#606060">  97:</span>&nbsp;&nbsp;&nbsp; ngx_destroy_pool(conf.temp_pool);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum98" style="color:#606060">  98:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum99" style="color:#606060">  99:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_process == NGX_PROCESS_MASTER || ngx_is_init_cycle(old_cycle)) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum100" style="color:#606060"> 100:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum101" style="color:#606060"> 101:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000">/*</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum102" style="color:#606060"> 102:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * perl_destruct() frees environ, if it is not the same as it was at</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum103" style="color:#606060"> 103:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * perl_construct() time, therefore we save the previous cycle</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum104" style="color:#606060"> 104:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * environment before ngx_conf_parse() where it will be changed.</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum105" style="color:#606060"> 105:</span> <span style="color:#008000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum106" style="color:#606060"> 106:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum107" style="color:#606060"> 107:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; env = environ;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum108" style="color:#606060"> 108:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; environ = senv;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum109" style="color:#606060"> 109:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum110" style="color:#606060"> 110:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_pool(old_cycle-&gt;pool);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum111" style="color:#606060"> 111:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cycle-&gt;old_cycle = NULL;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum112" style="color:#606060"> 112:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum113" style="color:#606060"> 113:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; environ = env;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum114" style="color:#606060"> 114:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum115" style="color:#606060"> 115:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> cycle;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum116" style="color:#606060"> 116:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum117" style="color:#606060"> 117:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum118" style="color:#606060"> 118:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum119" style="color:#606060"> 119:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_temp_pool == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum120" style="color:#606060"> 120:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_temp_pool = ngx_create_pool(128, cycle-&gt;log);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum121" style="color:#606060"> 121:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_temp_pool == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum122" style="color:#606060"> 122:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_error(NGX_LOG_EMERG, cycle-&gt;log, 0,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum123" style="color:#606060"> 123:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#006080">&quot;could not create ngx_temp_pool&quot;</span>);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum124" style="color:#606060"> 124:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit(1);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum125" style="color:#606060"> 125:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum126" style="color:#606060"> 126:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum127" style="color:#606060"> 127:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n = 10;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum128" style="color:#606060"> 128:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_old_cycles.elts = ngx_pcalloc(ngx_temp_pool,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum129" style="color:#606060"> 129:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n * <span style="color:#0000ff">sizeof</span>(ngx_cycle_t *));</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum130" style="color:#606060"> 130:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_old_cycles.elts == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum131" style="color:#606060"> 131:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit(1);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum132" style="color:#606060"> 132:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum133" style="color:#606060"> 133:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_old_cycles.nelts = 0;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum134" style="color:#606060"> 134:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_old_cycles.size = <span style="color:#0000ff">sizeof</span>(ngx_cycle_t *);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum135" style="color:#606060"> 135:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_old_cycles.nalloc = n;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum136" style="color:#606060"> 136:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_old_cycles.pool = ngx_temp_pool;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum137" style="color:#606060"> 137:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum138" style="color:#606060"> 138:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_cleaner_event.handler = ngx_clean_old_cycles;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum139" style="color:#606060"> 139:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_cleaner_event.log = cycle-&gt;log;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum140" style="color:#606060"> 140:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_cleaner_event.data = &amp;dumb;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum141" style="color:#606060"> 141:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dumb.fd = (ngx_socket_t) -1;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum142" style="color:#606060"> 142:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum143" style="color:#606060"> 143:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum144" style="color:#606060"> 144:</span>&nbsp;&nbsp;&nbsp; ngx_temp_pool-&gt;log = cycle-&gt;log;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum145" style="color:#606060"> 145:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum146" style="color:#606060"> 146:</span>&nbsp;&nbsp;&nbsp; old = ngx_array_push(&amp;ngx_old_cycles);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum147" style="color:#606060"> 147:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (old == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum148" style="color:#606060"> 148:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit(1);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum149" style="color:#606060"> 149:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum150" style="color:#606060"> 150:</span>&nbsp;&nbsp;&nbsp; *old = old_cycle;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum151" style="color:#606060"> 151:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum152" style="color:#606060"> 152:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (!ngx_cleaner_event.timer_set) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum153" style="color:#606060"> 153:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_add_timer(&amp;ngx_cleaner_event, 30000);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum154" style="color:#606060"> 154:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_cleaner_event.timer_set = 1;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum155" style="color:#606060"> 155:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum156" style="color:#606060"> 156:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum157" style="color:#606060"> 157:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> cycle;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum158" style="color:#606060"> 158:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum159" style="color:#606060"> 159:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum160" style="color:#606060"> 160:</span> ailed:</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum161" style="color:#606060"> 161:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum162" style="color:#606060"> 162:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (!ngx_is_init_cycle(old_cycle)) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum163" style="color:#606060"> 163:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; old_ccf = (ngx_core_conf_t *) ngx_get_conf(old_cycle-&gt;conf_ctx,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum164" style="color:#606060"> 164:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_core_module);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum165" style="color:#606060"> 165:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (old_ccf-&gt;environment) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum166" style="color:#606060"> 166:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; environ = old_ccf-&gt;environment;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum167" style="color:#606060"> 167:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum168" style="color:#606060"> 168:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum169" style="color:#606060"> 169:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum170" style="color:#606060"> 170:</span>&nbsp;&nbsp;&nbsp; <span style="color:#008000">/* rollback the new cycle configuration */</span></pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum171" style="color:#606060"> 171:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum172" style="color:#606060"> 172:</span>&nbsp;&nbsp;&nbsp; part = &amp;cycle-&gt;open_files.part;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum173" style="color:#606060"> 173:</span>&nbsp;&nbsp;&nbsp; file = part-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum174" style="color:#606060"> 174:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum175" style="color:#606060"> 175:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (i = 0; <span style="color:#008000">/* void */</span> ; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum176" style="color:#606060"> 176:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum177" style="color:#606060"> 177:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (i &gt;= part-&gt;nelts) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum178" style="color:#606060"> 178:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (part-&gt;next == NULL) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum179" style="color:#606060"> 179:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">break</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum180" style="color:#606060"> 180:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum181" style="color:#606060"> 181:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = part-&gt;next;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum182" style="color:#606060"> 182:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file = part-&gt;elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum183" style="color:#606060"> 183:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; i = 0;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum184" style="color:#606060"> 184:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum185" style="color:#606060"> 185:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum186" style="color:#606060"> 186:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (file[i].fd == NGX_INVALID_FILE || file[i].fd == ngx_stderr) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum187" style="color:#606060"> 187:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum188" style="color:#606060"> 188:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum189" style="color:#606060"> 189:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum190" style="color:#606060"> 190:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_close_file(file[i].fd) == NGX_FILE_ERROR) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum191" style="color:#606060"> 191:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_error(NGX_LOG_EMERG, log, ngx_errno,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum192" style="color:#606060"> 192:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_close_file_n <span style="color:#006080">&quot; \&quot;%s\&quot; failed&quot;</span>,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum193" style="color:#606060"> 193:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; file[i].name.data);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum194" style="color:#606060"> 194:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum195" style="color:#606060"> 195:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum196" style="color:#606060"> 196:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum197" style="color:#606060"> 197:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_test_config) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum198" style="color:#606060"> 198:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_destroy_cycle_pools(&amp;conf);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum199" style="color:#606060"> 199:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">return</span> NULL;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum200" style="color:#606060"> 200:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum201" style="color:#606060"> 201:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum202" style="color:#606060"> 202:</span>&nbsp;&nbsp;&nbsp; ls = cycle-&gt;listening.elts;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum203" style="color:#606060"> 203:</span>&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">for</span> (i = 0; i &lt; cycle-&gt;listening.nelts; i&#43;&#43;) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum204" style="color:#606060"> 204:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ls[i].fd == (ngx_socket_t) -1 || !ls[i].open) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum205" style="color:#606060"> 205:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">continue</span>;</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum206" style="color:#606060"> 206:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum207" style="color:#606060"> 207:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum208" style="color:#606060"> 208:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000ff">if</span> (ngx_close_socket(ls[i].fd) == -1) {</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum209" style="color:#606060"> 209:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_log_error(NGX_LOG_EMERG, log, ngx_socket_errno,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum210" style="color:#606060"> 210:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ngx_close_socket_n <span style="color:#006080">&quot; %V failed&quot;</span>,</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum211" style="color:#606060"> 211:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;ls[i].addr_text);</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum212" style="color:#606060"> 212:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum213" style="color:#606060"> 213:</span>&nbsp;&nbsp;&nbsp; }</pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum214" style="color:#606060"> 214:</span>&nbsp; </pre>
<pre style="border-style:none; overflow:visible; font-size:8pt; font-family:'Courier New',courier,monospace; width:100%; padding:0px; direction:ltr; margin:0em; line-height:12pt; background-color:rgb(244,244,244)"><span id="lnum215" style="color:#606060"> 215:</span>&nbsp;&nbsp;&nbsp; ngx_destroy_cycle_pools(&amp;conf);</pre>
</div>
</div>
</blockquote>
-<br>
<p>Echo Chen：<a target="_blank" target="_blank" href="http://blog.csdn.net/chen19870707">Blog.csdn.net/chen19870707</a></p>
<p>-</p>
</li>   
</div>




<!-- Baidu Button BEGIN -->




<div class="bdsharebuttonbox tracking-ad" style="float: right;" data-mod="popu_172">
<a href="#" class="bds_more" data-cmd="more" style="background-position:0 0 !important; background-image: url(http://bdimg.share.baidu.com/static/api/img/share/icons_0_16.png?v=d754dcc0.png) !important"></a>
<a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"  style="background-position:0 -52px !important"></a>
<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"style="background-position:0 -104px !important"></a>
<a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"style="background-position:0 -260px !important"></a>
<a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"style="background-position:0 -208px !important"></a>
<a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"style="background-position:0 -1612px !important" ></a>
</div>
<script>window._bd_share_config = { "common": { "bdSnsKey": {}, "bdText": "", "bdMini": "1", "bdMiniList": false, "bdPic": "", "bdStyle": "0", "bdSize": "16" }, "share": {} }; with (document) 0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];</script>
<!-- Baidu Button END -->

   <link rel="stylesheet" href="http://static.blog.csdn.net/css/blog_detail.css" />

    
<!--172.16.140.11-->

<!-- Baidu Button BEGIN -->
<script type="text/javascript" id="bdshare_js" data="type=tools&amp;uid=1536434" ></script>
<script type="text/javascript" id="bdshell_js"></script>
<script type="text/javascript">
    document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + Math.ceil(new Date()/3600000)
</script>
<!-- Baidu Button END -->

 


        <div id="digg" ArticleId="41050379" >
            <dl id="btnDigg" class="digg digg_disable"  onclick="btndigga();">
               
                 <dt>顶</dt>
                <dd>3</dd>
            </dl>
           
              
            <dl id="btnBury" class="digg digg_disable"  onclick="btnburya();">
              
                  <dt>踩</dt>
                <dd>0</dd>               
            </dl>
            
        </div>
     <div class="tracking-ad" data-mod="popu_222"><a href="javascript:void(0);" >&nbsp;</a>   </div>
    <div class="tracking-ad" data-mod="popu_223"> <a href="javascript:void(0);" >&nbsp;</a></div>
    <script type="text/javascript">
                function btndigga() {
                    $(".tracking-ad[data-mod='popu_222'] a").click();
                }
                function btnburya() {
                    $(".tracking-ad[data-mod='popu_223'] a").click();
                }
            </script>

   <ul class="article_next_prev">
                <li class="prev_article"><span  onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_shangyipian']);location.href='/chen19870707/article/details/41017725';">上一篇</span><a href="/chen19870707/article/details/41017725" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_shangyipian'])">菜鸟nginx源码剖析数据结构篇（十） 自旋锁ngx_spinlock</a></li>
                <li class="next_article"><span onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_xiayipian']);location.href='/chen19870707/article/details/41083183';">下一篇</span><a href="/chen19870707/article/details/41083183" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_xiayipian'])">CAS原子操作实现无锁及性能分析</a></li>
    </ul>

    <div style="clear:both; height:10px;"></div>


        <div class="similar_article"  style="display:none">
                <h4>我的同类文章</h4>
                <div class="similar_c"style="margin:20px 0px 0px 0px">
                    <div class="similar_c_t">
                                <label class="similar_cur">
                                    <span  style="cursor:pointer"  onclick="GetCategoryArticles('2647301','chen19870707','foot','41050379');">Server - 菜鸟nginx源码剖析<em>（13）</em></span>
                                </label>
                    </div>
                   
                    <div class="similar_wrap tracking-ad" data-mod="popu_141"  style="max-height:195px;">
                        <a href="http://blog.csdn.net" style="display:none">http://blog.csdn.net</a>
                        <ul class="similar_list fl">                          
                        </ul>

                        <ul class="similar_list fr">                           
                        </ul>
                    </div>
                </div>
            </div>    
    <script  type="text/javascript">
        $(function () {
            GetCategoryArticles('2647301', 'chen19870707','foot','41050379');
        });
    </script>
      
</div>

     <div>
                <script type="text/javascript">
                    /*博客内容页下方Banner1-960*90，创建于2016-12-13*/
                    var cpro_id = "u2843955";
                </script>
                <script type="text/javascript" src="http://cpro.baidustatic.com/cpro/ui/c.js"></script>
    </div>

<div id="suggest"></div>
         <script  language="javascript" type='text/javascript'>     
             $(function(){
                 $.get("/chen19870707/svc/GetSuggestContent/41050379",function(data){
                     $("#suggest").html(data);
                 });     
             });             
         </script>  


<style>
.blog-ass-articl dd {
color: #369;
width: 99%; /*修改行*/
float: left;
overflow: hidden;
font: normal normal 12px/23px "SimSun";
height: 23px;
margin: 0;
padding: 0 0 0 10px;
margin-right: 30px;
background: url(http://static.blog.csdn.net/skin/default/images/blog-dot-red3.gif) no-repeat 0 10px;
}
</style>

 <link rel="stylesheet" href="http://static.blog.csdn.net/css/replace.css"/>
<div id="relate" data-mod="popu_218"  class="tracking-ad">
        <div class="relate_t">
            <h3><span>参考知识库</span></h3>
        </div>
        <div class="relate_c">
        </div>
</div>
 

<dl class="blog-ass-articl" id="res-relatived" > 
    <div class="embody embody_b" id="libkeyparent"  style="display:none">
            <span class="embody_t">更多资料请参考：</span>
            <div class="embody_c" id="libkey"></div>
    </div>


     <dt><span>猜你在找</span></dt>    


   


    <div id="adCollege" style="width: 42%;float: left;"> 
        <script src="http://csdnimg.cn/jobreco/job_reco.js" type="text/javascript"></script> 
        <script type="text/javascript">
            csdn.position.showEdu({
                sourceType: "blog",
                searchType: "detail",
                searchKey: "41050379",
                username: "",
                recordcount: "5",
                containerId: "adCollege" //容器DIV的id。 
            });
        </script> 
    </div>  

    
     <div id="res"  data-mod="popu_36"  class="tracking-ad" style="width: 42%;float: left;margin-right: 30px;"></div>
   
</dl>


<script type="text/javascript">
    $(function () {
        setTimeout(function () {
            var searchtitletags = '菜鸟nginx源码剖析 框架篇（一） 从main函数看nginx启动流程' + ',' + $("#tags").html();
            searchService({
                index: 'blog',
                query: searchtitletags,
                from: 5,
                size: 5,
                appendTo: '#res',
                url: 'recommend',
                his: 2,
                client: "blog_cf_enhance",
                tmpl: '<dd style="background:url(http://static.blog.csdn.net/skin/default/images/blog-dot-red3.gif) no-repeat 0 10px;"><a href="#{ url }" title="#{ title }" strategy="#{ strategy }">#{ title }</a></dd>'
            });
        }, 500);
    });    

 </script>  


    <div id="ad_cen">        
                    <script type="text/javascript">
                        /*博客内容页下方Banner-728*90，创建于2014-7-3*/
                        var cpro_id = "u1607657";
                    </script>
                    <script type="text/javascript" src="http://cpro.baidustatic.com/cpro/ui/c.js"></script>
    </div>  


<div class="comment_class">
    <div id="comment_title" class="panel_head">
        <span class="see_comment">查看评论</span><a name="comments"></a></div>
    <div id="comment_list">
    </div>
    <div id="comment_bar">
    </div>
    <div id="comment_form">
    </div>
    <div class="announce">
        * 以上用户言论只代表其个人观点，不代表CSDN网站的观点或立场<a name="reply"></a><a name="quote"></a></div>
</div>

<script type="text/javascript">
    var fileName = '41050379';
    var commentscount = 5;
    var islock = false
</script>
<script type="text/javascript" src="http://static.blog.csdn.net/scripts/comment.js"></script>
    <div id="ad_bot">
    </div>
<div id="report_dialog">
</div>

<div id="d-top"  style="bottom:60px;">

        <a id="quick-reply" class="btn btn-top q-reply" title="快速回复" style="display:none;">
            <img src="http://static.blog.csdn.net/images/blog-icon-reply.png" alt="快速回复">
        </a>    
    <a id="d-top-a" class="btn btn-top backtop"  style="display: none;" title="返回顶部" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_huidaodingbu'])" style="">         
         <img src="http://static.blog.csdn.net/images/top.png" alt="TOP">
    </a>
</div>
<script type="text/javascript">
    $(function ()
    {
        $("#ad_frm_0").height("90px");
        
        setTimeout(function(){
            $("#ad_frm_2").height("200px");
        },1000);    
    });
  
</script>
<style type="text/css">
    .tag_list
    {
        background: none repeat scroll 0 0 #FFFFFF;
        border: 1px solid #D7CBC1;
        color: #000000;
        font-size: 12px;
        line-height: 20px;
        list-style: none outside none;
        margin: 10px 2% 0 1%;
        padding: 1px;
    }
    .tag_list h5
    {
        background: none repeat scroll 0 0 #E0DBD3;
        color: #47381C;
        font-size: 12px;
        height: 24px;
        line-height: 24px;
        padding: 0 5px;
        margin: 0;
    }
    .tag_list h5 a
    {
        color: #47381C;
    }
    .classify
    {
        margin: 10px 0;
        padding: 4px 12px 8px;
    }
    .classify a
    {
        margin-right: 20px;
        white-space: nowrap;
    }
</style>


<div class="tag_list" style="display:none"></div>
  <script  language="javascript" type='text/javascript'>     
      $(function(){
              setTimeout(function(){
                  $.get("/chen19870707/svc/GetTagContent",function(data){
                      $(".tag_list").html(data).show();
                  });     
              });
          },500);                       
 </script> 


<div id="pop_win" style="display:none ;position: absolute; z-index: 10000; border: 1px solid rgb(220, 220, 220); top: 222.5px; left: 630px; opacity: 1; background: none 0px 0px repeat scroll rgb(255, 255, 255);">
    
</div>
<div id="popup_mask"></div>
<style>
    #popup_mask
    {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 9999;
        left: 0px;
        top: 0px;
        opacity: 0.3;
        filter: alpha(opacity=30);
        display: none;
    }

</style>




<script type="text/javascript">
    $(function(){
        setTimeout(function(){
            $(".comment_body:contains('回复')").each(function(index,item){
                var u=$(this).text().split('：')[0].toString().replace("回复","")
                var thisComment=$(this);
                if(u)
                {
                    $.getJSON("https://passport.csdn.net/get/nick?callback=?", {users: u}, function(a) {
                        if(a!=null&&a.data!=null&&a.data.length>0)
                        {
                            nick=a.data[0].n; 
                            if(u!=nick)
                            {
                                thisComment.text(thisComment.text().replace(u,nick));  
                            }
                        }       
                    });  
                }
            });         

        },200);  

        setTimeout(function(){
            $(".math").each(function(index,value){$(this).find("span").last().css("color","#fff"); })
        },5000);

        setTimeout(function(){
            $(".math").each(function(index,value){$(this).find("span").last().css("color","#fff"); })
        },10000);

        setTimeout(function(){
            $(".math").each(function(index,value){$(this).find("span").last().css("color","#fff"); })
        },15000);
        
        setTimeout(function(){
            $("a img[src='http://js.tongji.linezing.com/stats.gif']").parent().css({"position":"absolute","left":"50%"});
        },300);
    });

    function loginbox(){
        var $logpop=$("#pop_win");
        $logpop.html('<iframe src="https://passport.csdn.net/account/loginbox?service=http://static.blog.csdn.net/callback.htm" frameborder="0" height="600" width="400" scrolling="no"></iframe>');

        $('#popup_mask').css({
            opacity: 0.5,
            width: $( document ).width() + 'px',
            height:  $( document ).height() + 'px'
        });
        $('#popup_mask').css("display","block");
 
        $logpop.css( {
            top: ($( window ).height() - $logpop.height())/ 2  + $( window 
       ).scrollTop() + 'px',
            left:($( window ).width() - $logpop.width())/ 2
        } );
 
        setTimeout( function () {
            $logpop.show();
            $logpop.css( {
                opacity: 1
            } );
        }, 200 );
 
        $('#popup_mask').unbind("click");
        $('#popup_mask').bind("click", function(){
            $('#popup_mask').hide();
            var $clopop = $("#pop_win");
            $("#common_ask_div_sc").css("display","none");
            $clopop.css( {
                opacity: 0
            } );
            setTimeout( function () {
                $clopop.hide();
            }, 350 );
            return false;
        });
    }   

</script>
 <script language="javascript" type="text/javascript" src="http://ads.csdn.net/js/async_new.js"></script>      




                        <div class="clear">
                        </div>
                    </div>                   
                
            </div>
                   
           <div id="side">
               
    <div class="side">
<div id="panel_Profile" class="panel">
<ul class="panel_head"><span>个人资料</span></ul>
<ul class="panel_body profile">
<div id="blog_userface">
    <a href="http://my.csdn.net/chen19870707" target="_blank">
    <img src="http://avatar.csdn.net/8/E/2/1_chen19870707.jpg" title="访问我的空间" style="max-width:90%"/>
    </a>
    <br />
    <span><a href="http://my.csdn.net/chen19870707" class="user_name" target="_blank">chen19870707</a></span>
</div>
<div class="interact">

    <a href="javascript:void(0);" class="attent" id="span_add_follow" title="[加关注]"></a>

 <a href="javascript:void(0);" class="letter"  title="[发私信]" onclick="window.open('http://msg.csdn.net/letters/model?receiver=chen19870707','_blank','height=350,width=700');_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_sixin'])"></a>  
</div>
<div id="blog_medal">
                         <div class="ico_expert" title="CSDN博客准专家"  onclick="javascript:location='http://blog.csdn.net/experts/rule.html'" style=" cursor:pointer;width:54px;height:60px;background:url('http://c.csdnimg.cn/jifen/images/xunzhang/xunzhang/bokezhunzhuanjiamiddle.png') no-repeat" ></div>
                <div id="bms_box">
                                            <a  target="_blank">
                                                    <img src="http://c.csdnimg.cn/jifen/images/xunzhang/xunzhang/zhuanlandaren.png" onmouseover="m_over_m(this,2)" onmouseout="m_out_m()" alt="2" >
                                            </a>
                                            <a  target="_blank">
                                                    <img src="http://c.csdnimg.cn/jifen/images/xunzhang/xunzhang/chizhiyiheng.png" onmouseover="m_over_m(this,4)" onmouseout="m_out_m()" alt="2" >
                                            </a>
               </div>
</div>
<ul id="blog_rank">
    <li>访问：<span>748509次</span></li>
    <li>积分：<span>4991</span> </li>    
    <li >等级： <span style="position:relative;display:inline-block;z-index:1" >
            <img src="http://c.csdnimg.cn/jifen/images/xunzhang/jianzhang/blog5.png" alt="" style="vertical-align: middle;" id="leveImg">
            <div id="smallTittle" style=" position: absolute;  left: -24px;  top: 25px;  text-align: center;  width: 101px;  height: 32px;  background-color: #fff;  line-height: 32px;  border: 2px #DDDDDD solid;  box-shadow: 0px 2px 2px rgba (0,0,0,0.1);  display: none;   z-index: 999;">
            <div style="left: 42%;  top: -8px;  position: absolute;  width: 0;  height: 0;  border-left: 10px solid transparent;  border-right: 10px solid transparent;  border-bottom: 8px solid #EAEAEA;"></div>
            积分：4991 </div>
        </span>  </li>
    <li>排名：<span>第4451名</span></li>
</ul>
<ul id="blog_statistics">
    <li>原创：<span>49篇</span></li>
    <li>转载：<span>4篇</span></li>
    <li>译文：<span>4篇</span></li>
    <li>评论：<span>160条</span></li>
</ul>
</ul>
</div>




<div id="custom_column_37363329" class="panel">
<ul class="panel_head"><span>博客公告</span></ul>
<ul class="panel_body">

<div id="custom_column_17387915" class="panel">
<ul class="panel_head">
<span>博客公告</span></ul>
<ul class="panel_body">
<b><font color="red">谢谢大家的关注和支持，大家一起学习。</font></b>
<hr>
新浪微博：<font color="red"><a href="http://weibo.com/u/2534653810/home?wvr=5" target="_blank">二狗陈Chen</a></font><a href="http://weibo.com/u/2534653810/home?wvr=5" target="_blank"><br>
</a>
<center><a href="http://weibo.com/u/2534653810/home?wvr=5" target="_blank"></a><a href="http://weibo.com/u/2534653810/home?wvr=5" target="_blank"><img src="http://img.my.csdn.net/uploads/201411/08/1415438651_6545.jpg" width="150" height="“150”"></a></center>
<a href="http://www.ed365.com" target="_blank">
<hr>
<hr>
<font color="blue">博主简介</font>：Echo，游戏后台工程师。 <font color="red">博主拥有该Blog内全部原创文章的所有权利。欢迎以任何形式转载，但务必注明原文链接。任何个人、组织、网站、出版社不得在未经本人许可的情况下用于商业目的。</font>
<hr>
如果我的博文对你有所帮助，欢迎你评论留言，这是对我最大的鼓励。如果你发现我的博文有谬误，请你务必指正，这是对我和其他读者的莫大的帮助。 <br>
</a></ul>
<a href="http://www.ed365.com" target="_blank"></a></div>
<a href="http://www.ed365.com" target="_blank"></a>

</ul>
</div><div id="panel_Category" class="panel">
    <ul class="panel_head"><span>博客专栏</span></ul>
    <ul class="panel_body" id="sp_column">
    <table cellpadding="0" cellspacing="0"><tr>
    <td style="padding:10px 10px 0 0;">
    <a href="http://blog.csdn.net/column/details/niginxsourcelearning.html" target="_blank"><img src="http://img.blog.csdn.net/20151123180051317" style="width:75px;height:75px;" /></a>
    </td>
    <td style="padding:10px 0; vertical-align:top;">
    <a href="http://blog.csdn.net/column/details/niginxsourcelearning.html" target="_blank">nginx源码剖析</a>
    <p>文章：14篇</p>
    <span>阅读：234845</span>
    </td>
    </tr></table>
    <table cellpadding="0" cellspacing="0"><tr>
    <td style="padding:10px 10px 0 0;">
    <a href="http://blog.csdn.net/column/details/tcmalloclearning.html" target="_blank"><img src="http://img.blog.csdn.net/20151123180045989" style="width:75px;height:75px;" /></a>
    </td>
    <td style="padding:10px 0; vertical-align:top;">
    <a href="http://blog.csdn.net/column/details/tcmalloclearning.html" target="_blank">TCMalloc原理和使用</a>
    <p>文章：5篇</p>
    <span>阅读：228552</span>
    </td>
    </tr></table>
    </ul>
</div><div id="panel_Category" class="panel">
<ul class="panel_head"><span>文章分类</span></ul>
<ul class="panel_body">    
                 <li>
                    <a href="/chen19870707/article/category/726519" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Lang. - C/C++</a><span>(6)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/2589985" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Dev. Tools - Compiler</a><span>(6)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/2593299" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Server - Database</a><span>(1)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/2607051" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Server - Perception</a><span>(1)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/2621993" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Server - Linux Kernal</a><span>(1)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/2628763" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Server - Tcmalloc</a><span>(5)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/2619017" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Server - 高级数据结构</a><span>(5)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/2647301" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Server - 菜鸟nginx源码剖析</a><span>(14)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/2617611" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Learning. - Plan</a><span>(1)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/1228520" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">试题 - 算法/数据结构</a><span>(16)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/3065025" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Server-nodejs</a><span>(0)</span>
                </li>
                 <li>
                    <a href="/chen19870707/article/category/3065029" onclick="_gaq.push(['_trackEvent','function', 'onclick', 'blog_articles_wenzhangfenlei']); ">Server - nodejs</a><span>(1)</span>
                </li>
</ul>
</div><div id="panel_Archive" class="panel">
<ul class="panel_head"><span>文章存档</span></ul>
<ul class="panel_body">
<div id="archive_list">
<!--归档统计-->
<li><a href="/chen19870707/article/month/2015/03">2015年03月</a><span>(1)</span></li><li><a href="/chen19870707/article/month/2015/02">2015年02月</a><span>(1)</span></li><li><a href="/chen19870707/article/month/2015/01">2015年01月</a><span>(4)</span></li><li><a href="/chen19870707/article/month/2014/11">2014年11月</a><span>(10)</span></li><li><a href="/chen19870707/article/month/2014/10">2014年10月</a><span>(15)</span></li><li><a href="/chen19870707/article/month/2014/09">2014年09月</a><span>(6)</span></li><li><a href="/chen19870707/article/month/2012/09">2012年09月</a><span>(17)</span></li><li><a href="/chen19870707/article/month/2010/08">2010年08月</a><span>(4)</span></li>
</div>
</ul>
</div>
<div id="hotarticls" class="panel">
<ul class="panel_head">
    <span>       
阅读排行    </span>
</ul>

<ul class="panel_body itemlist">
<li>
<a href="/chen19870707/article/details/40301783" title="TCMalloc 安装和使用">TCMalloc 安装和使用</a><span>(75952)</span>
</li>
<li>
<a href="/chen19870707/article/details/40343827" title="菜鸟nginx源码剖析数据结构篇（一）动态数组ngx_array_t">菜鸟nginx源码剖析数据结构篇（一）动态数组ngx_array_t</a><span>(65090)</span>
</li>
<li>
<a href="/chen19870707/article/details/40145565" title="使用Tcmalloc进行堆栈分析">使用Tcmalloc进行堆栈分析</a><span>(64647)</span>
</li>
<li>
<a href="/chen19870707/article/details/40302911" title="TCMalloc 对MYSQL 性能 优化的分析">TCMalloc 对MYSQL 性能 优化的分析</a><span>(64289)</span>
</li>
<li>
<a href="/chen19870707/article/details/41083183" title="CAS原子操作实现无锁及性能分析">CAS原子操作实现无锁及性能分析</a><span>(36309)</span>
</li>
<li>
<a href="/chen19870707/article/details/41015613" title="菜鸟nginx源码剖析数据结构篇（九） 内存池ngx_pool_t">菜鸟nginx源码剖析数据结构篇（九） 内存池ngx_pool_t</a><span>(23455)</span>
</li>
<li>
<a href="/chen19870707/article/details/43202679" title="为什么linux下多线程程序如此消耗虚拟内存">为什么linux下多线程程序如此消耗虚拟内存</a><span>(21555)</span>
</li>
<li>
<a href="/chen19870707/article/details/41050379" title="菜鸟nginx源码剖析 框架篇（一） 从main函数看nginx启动流程">菜鸟nginx源码剖析 框架篇（一） 从main函数看nginx启动流程</a><span>(21471)</span>
</li>
<li>
<a href="/chen19870707/article/details/39585277" title="手把手实现红黑树">手把手实现红黑树</a><span>(20375)</span>
</li>
<li>
<a href="/chen19870707/article/details/39994303" title="眉目传情之并发无锁环形队列的实现">眉目传情之并发无锁环形队列的实现</a><span>(19419)</span>
</li>
</ul>
</div>
<div id="hotarticls2" class="panel">
<ul class="panel_head"><span>评论排行</span></ul>
<ul class="panel_body itemlist">
<li>
<a href="/chen19870707/article/details/43202679" title="为什么linux下多线程程序如此消耗虚拟内存">为什么linux下多线程程序如此消耗虚拟内存</a><span>(30)</span>
</li>
<li>
<a href="/chen19870707/article/details/41083183" title="CAS原子操作实现无锁及性能分析">CAS原子操作实现无锁及性能分析</a><span>(20)</span>
</li>
<li>
<a href="/chen19870707/article/details/41015613" title="菜鸟nginx源码剖析数据结构篇（九） 内存池ngx_pool_t">菜鸟nginx源码剖析数据结构篇（九） 内存池ngx_pool_t</a><span>(15)</span>
</li>
<li>
<a href="/chen19870707/article/details/40343827" title="菜鸟nginx源码剖析数据结构篇（一）动态数组ngx_array_t">菜鸟nginx源码剖析数据结构篇（一）动态数组ngx_array_t</a><span>(12)</span>
</li>
<li>
<a href="/chen19870707/article/details/40400719" title="菜鸟nginx源码剖析数据结构篇（三） 单向链表 ngx_list_t">菜鸟nginx源码剖析数据结构篇（三） 单向链表 ngx_list_t</a><span>(9)</span>
</li>
<li>
<a href="/chen19870707/article/details/39994303" title="眉目传情之并发无锁环形队列的实现">眉目传情之并发无锁环形队列的实现</a><span>(9)</span>
</li>
<li>
<a href="/chen19870707/article/details/39899743" title="眉目传情之匠心独运的kfifo">眉目传情之匠心独运的kfifo</a><span>(9)</span>
</li>
<li>
<a href="/chen19870707/article/details/39694517" title="游戏服务器设计的一些感悟">游戏服务器设计的一些感悟</a><span>(8)</span>
</li>
<li>
<a href="/chen19870707/article/details/39585277" title="手把手实现红黑树">手把手实现红黑树</a><span>(8)</span>
</li>
<li>
<a href="/chen19870707/article/details/40515287" title="菜鸟nginx源码剖析数据结构篇（四）红黑树ngx_rbtree_t">菜鸟nginx源码剖析数据结构篇（四）红黑树ngx_rbtree_t</a><span>(7)</span>
</li>
</ul>
</div>
<div id="homepageArticles" class="panel tracking-ad" data-mod="popu_4">
<ul class="panel_head"><span>推荐文章</span></ul>
<ul class="panel_body" id="ad_commend">
<ul>
<li><a href="http://blog.csdn.net/laoyang360/article/details/53843771" target="_blank">* 而立之年——三线城市程序员的年终告白</a></li>
<li><a href="http://blog.csdn.net/sdkfjksf/article/details/54380659" 
target="_blank">* Java集合框架中隐藏的设计套路</a></li>
<li><a href="http://blog.csdn.net/jiangwei0910410003/article/details/54092364" 
target="_blank">* Python脚本下载今日头条视频(附加Android版本辅助下载器)</a></li>
<li><a href="http://blog.csdn.net/caowenbin/article/details/54406716" target="_blank">* 人工智能的冷思考</a></li>
<li><a href="http://blog.csdn.net/it_talk/article/details/54346566" 
target="_blank">* React Native 实战系列教程之热更新原理分析与实现</a></li>


</ul></ul>
</div>


<div id="newcomments" class="panel">
<ul class="panel_head"><span>最新评论</span></ul>
<ul class="panel_body itemlist">
    <li>
   
         <a href="/chen19870707/article/details/39994303#comments">眉目传情之并发无锁环形队列的实现</a>
    <p style="margin:0px;"><a href="/louisejackie" class="user_name">louisejackie</a>:
测试了下，没有内存屏障不好使啊。
    </p>
    </li>
    <li>
   
         <a href="/chen19870707/article/details/39899743#comments">眉目传情之匠心独运的kfifo</a>
    <p style="margin:0px;"><a href="/linyt" class="user_name">linyt</a>:
@mcv82:volatile和mb是两回事，达不到这个效果
    </p>
    </li>
    <li>
   
         <a href="/chen19870707/article/details/39899743#comments">眉目传情之匠心独运的kfifo</a>
    <p style="margin:0px;"><a href="/lbknxy" class="user_name">lbknxy</a>:
谢谢楼主分享。 请问 in 和 out 修改和读取采用内存屏障，写线程正在写，此时读线程想去读，也通...
    </p>
    </li>
    <li>
   
         <a href="/chen19870707/article/details/40400719#comments">菜鸟nginx源码剖析数据结构篇（三） 单向链表 ngx_list_t</a>
    <p style="margin:0px;"><a href="/zhangxiao93" class="user_name">zhangxiao93</a>:
建议贴出运行结果可参考参考～
    </p>
    </li>
    <li>
   
         <a href="/chen19870707/article/details/39546409#comments">MySQL bin-log分析方法</a>
    <p style="margin:0px;"><a href="/oneunited01" class="user_name">oneunited01</a>:
谢谢你的文章，处理了一个问题，谢谢
    </p>
    </li>
    <li>
   
         <a href="/chen19870707/article/details/43202679#comments">为什么linux下多线程程序如此消耗虚拟内存</a>
    <p style="margin:0px;"><a href="/anchenggang" class="user_name">anchenggang</a>:
厉害~MALLOC_ARENA_MAX 原来是这个意思~
    </p>
    </li>
    <li>
   
         <a href="/chen19870707/article/details/40343827#comments">菜鸟nginx源码剖析数据结构篇（一）动态数组ngx_array_t</a>
    <p style="margin:0px;"><a href="/u014676491" class="user_name">u014676491</a>:
ngx_array_destroy中为什么是p = a-&gt;pool而不是p=a-&gt;pool.d-&gt;n...
    </p>
    </li>
    <li>
   
         <a href="/chen19870707/article/details/40301783#comments">TCMalloc 安装和使用</a>
    <p style="margin:0px;"><a href="/u012398613" class="user_name">u012398613</a>:
看了你的很多博客，也分享了一些。想问问TCMalloc的堆栈分析感觉好麻烦，不如valgrind简洁...
    </p>
    </li>
    <li>
   
         <a href="/chen19870707/article/details/40371047#comments">菜鸟nginx源码剖析数据结构篇（二） 双向链表ngx_queue_t</a>
    <p style="margin:0px;"><a href="/liwf616" class="user_name">liwf616</a>:
你这个测试程序是怎么写的？
    </p>
    </li>
    <li>
   
         <a href="/chen19870707/article/details/40371047#comments">为什么linux下多线程程序如此消耗虚拟内存</a>
    <p style="margin:0px;"><a href="/9527" class="user_name">9527</a>:
赞，我也遇到一样的问题，个人认为c语言的优点是程序员自己来处理这些问题，我认为他们越界了。。。
    </p>
    </li>
</ul>
</div>
    </div>
    <div class="clear">
    </div>


                 <!-- 广告位开始 --> 
                    <ins data-revive-zoneid="189" data-revive-id="8c38e720de1c90a6f6ff52f3f89c4d57"></ins> 
                <!-- 广告位结束 -->

           </div>   

            <div class="clear">
            </div>
        </div>

        

<script type="text/javascript" src="http://c.csdnimg.cn/rabbit/cnick/cnick.js"></script>
<script type="text/javascript" src="http://static.blog.csdn.net/scripts/newblog.min.js"></script>


<script type="text/javascript" src="http://medal.blog.csdn.net/showblogmedal.ashx?blogid=611880"></script>
<script type="text/javascript" src="http://static.blog.csdn.net/scripts/JavaScript1.js"></script>

    <script type="text/javascript" src="http://passport.csdn.net/content/loginbox/login.js"></script>
<script type="text/javascript">document.write("<img src=http://counter.csdn.net/pv.aspx?id=24 border=0 width=0 height=0>");</script>
<script type="text/javascript" src="http://www.csdn.net/ui/scripts/Csdn/counter.js"></script>
<script type="text/javascript" src="http://ad.csdn.net/scripts/ad-blog.js"></script>
<script type="text/javascript">
    $(function () {
        function __get_code_toolbar(snippet_id) {
            return $("<span class='tracking-ad' data-mod='popu_167'><a href='https://code.csdn.net/snippets/"
                    + snippet_id
                    + "' target='_blank' title='在CODE上查看代码片'  style='text-indent:0;'><img src='https://code.csdn.net/assets/CODE_ico.png' width=12 height=12 alt='在CODE上查看代码片' style='position:relative;top:1px;left:2px;'/></a></span>"
                    + "<span class='tracking-ad' data-mod='popu_170'><a href='https://code.csdn.net/snippets/"
                    + snippet_id
                    + "/fork' target='_blank' title='派生到我的代码片' style='text-indent:0;'><img src='https://code.csdn.net/assets/ico_fork.svg' width=12 height=12 alt='派生到我的代码片' style='position:relative;top:2px;left:2px;'/></a></span>");
        }
        
        $("[code_snippet_id]").each(function () {
            __s_id = $(this).attr("code_snippet_id");
            if (__s_id != null && __s_id != "" && __s_id != 0 && parseInt(__s_id) > 70020) {
                __code_tool = __get_code_toolbar(__s_id);
                $(this).prev().find(".tools").append(__code_tool);
            }
        });

        $(".bar").show();
    });
</script>





    </div>
      <!--new top-->
    
    <script id="csdn-toolbar-id" btnId="header_notice_num" wrapId="note1" count="5" subCount="5" type="text/javascript" src="http://c.csdnimg.cn/public/common/toolbar/js/toolbar.js"></script>     <!--new top-->
   
    <link href="http://c.csdnimg.cn/comm_ask/css/ask_float_block.css" type="text/css" rel="stylesheet" />
    <script language='JavaScript' type='text/javascript' src='http://c.csdnimg.cn/comm_ask/js/libs/wmd.js'></script>
    <script language='JavaScript' type='text/javascript' src='http://c.csdnimg.cn/comm_ask/js/libs/showdown.js'></script>
    <script language='JavaScript' type='text/javascript' src='http://c.csdnimg.cn/comm_ask/js/libs/prettify.js'></script>
    <script language='JavaScript' type='text/javascript' src='http://c.csdnimg.cn/comm_ask/js/apps/ask_float_block.js'></script>
   

   

  <div id="a52b5334d" style="width: 1px; height: 1px; display: none;">
                    <script id="adJs52b5334"></script>
                    <script>document.getElementById("adJs52b5334").src = "http://ads.csdn.net/js/opt/52b5334.js?t=" + Math.random();</script>
   </div>

    <link rel="stylesheet" href="http://static.blog.csdn.net/css/blog_code.css" />
    <script type="text/javascript" src="http://static.blog.csdn.net/scripts/saveToCode.js"></script>
      <script type="text/javascript" src="//csdnimg.cn/rabbit/tracking-ad/main.js?75eacd8"></script>

     <link rel="stylesheet" href="http://static.blog.csdn.net/css/fa.css" />

    <div class="pop_CA_cover"  style="display:none"></div>
    <div class="pop pop_CA"  style="display:none">
          <div class="CA_header">
            收藏助手
            <span class="cancel_icon"  id="fapancle"  onclick="$('.pop_CA').hide();$('.pop_CA_cover').hide();"></span>
          </div>
          <iframe src="" id="fa" frameborder="0" width="100%" height="360"  scrolling="no" />
    </div>
</body>
</html>   
 